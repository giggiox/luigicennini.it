<!DOCTYPE html>
<html>

<head><meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">
<meta http-equiv="Accept-CH" content="DPR, Viewport-Width, Width">
<link rel="icon" href=https://avatars.githubusercontent.com/u/29329312?v&#61;4 type="image/gif">


<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link rel="preload"
      as="style"
      href="https://fonts.googleapis.com/css2?family=Alata&family=Lora:ital,wght@0,400;0,500;0,600;0,700;1,400;1,500;1,600;1,700&family=Roboto:ital,wght@0,100;0,300;0,400;0,500;0,700;0,900;1,100;1,300;1,400;1,500;1,700;1,900&display=swap"
>
<link rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Alata&family=Lora:ital,wght@0,400;0,500;0,600;0,700;1,400;1,500;1,600;1,700&family=Roboto:ital,wght@0,100;0,300;0,400;0,500;0,700;0,900;1,100;1,300;1,400;1,500;1,700;1,900&display=swap"
      media="print" onload="this.media='all'" />
<noscript>
  <link
          href="https://fonts.googleapis.com/css2?family=Alata&family=Lora:ital,wght@0,400;0,500;0,600;0,700;1,400;1,500;1,600;1,700&family=Roboto:ital,wght@0,100;0,300;0,400;0,500;0,700;0,900;1,100;1,300;1,400;1,500;1,700;1,900&display=swap"
          rel="stylesheet">
</noscript>


<link rel="stylesheet" href="/css/font.css" media="all">



<meta property="og:title" content="fork telemetry" />
<meta property="og:description" content="Introduction The aim of this project is to develop a cheaper alternative to the telemetry systems available on the market for mountain bikes.
Telemetry systems for mountain bikes monitor and acquire data on the position of the bike&rsquo;s fork and shock absorber while riding. This data is crucial for off-road sports enthusiasts and professional athletes, as it provides valuable information for analysing and improving performance.
Currently, many telemetry systems, such as byb telemetry, use expensive linear potentiometers to accurately measure the position of the fork and shock absorber." />
<meta property="og:type" content="article" />
<meta property="og:url" content="/en/projects/fork-telemetry/" /><meta property="article:section" content="projects" />
<meta property="article:published_time" content="2023-04-03T19:53:33+05:30" />
<meta property="article:modified_time" content="2023-04-03T19:53:33+05:30" /><meta property="og:site_name" content="Luigi Cennini" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="fork telemetry"/>
<meta name="twitter:description" content="Introduction The aim of this project is to develop a cheaper alternative to the telemetry systems available on the market for mountain bikes.
Telemetry systems for mountain bikes monitor and acquire data on the position of the bike&rsquo;s fork and shock absorber while riding. This data is crucial for off-road sports enthusiasts and professional athletes, as it provides valuable information for analysing and improving performance.
Currently, many telemetry systems, such as byb telemetry, use expensive linear potentiometers to accurately measure the position of the fork and shock absorber."/>


<link rel="stylesheet" href="/bootstrap-5/css/bootstrap.min.css" media="all"><link rel="stylesheet" href="/css/header.css" media="all">
<link rel="stylesheet" href="/css/footer.css" media="all">


<link rel="stylesheet" href="/css/theme.css" media="all">




<style>
    :root {
        --text-color: #343a40;
        --text-secondary-color: #6c757d;
        --background-color: #eaedf0;
        --secondary-background-color: #64ffda1a;
        --primary-color: #007bff;
        --secondary-color: #f8f9fa;

         
        --text-color-dark: #e4e6eb;
        --text-secondary-color-dark: #b0b3b8;
        --background-color-dark: #18191a;
        --secondary-background-color-dark: #212529;
        --primary-color-dark: #ffffff;
        --secondary-color-dark: #212529;
    }
    body {
        font-size: 1rem;
        font-weight: 400;
        line-height: 1.5;
        text-align: left;
    }

    html {
        background-color: var(--background-color) !important;
    }

    body::-webkit-scrollbar {
        width: .5em;
        height: .5em;
        background-color: var(--background-color);
    }
    
    ::-webkit-scrollbar-track {
        box-shadow: inset 0 0 6px var(--background-color);
        border-radius: 1rem;
    }
    
    ::-webkit-scrollbar-thumb {
        border-radius: 1rem;
        background-color: var(--secondary-color);
        outline: 1px solid var(--background-color);
    }

    #search-content::-webkit-scrollbar {
        width: .5em;
        height: .1em;
        background-color: var(--background-color);
    }
</style>

<meta name="description" content="">
<link rel="stylesheet" href="/css/single.css">


<script defer src="/fontawesome-5/all-5.15.4.js"></script>

  <title>
fork telemetry | luigi cennini

  </title>
</head>

<body class="light">
  
  
<script>
    let localStorageValue = localStorage.getItem("pref-theme");
    let mediaQuery = window.matchMedia('(prefers-color-scheme: dark)').matches;

    switch (localStorageValue) {
        case "dark":
            document.body.classList.add('dark');
            break;
        case "light":
            document.body.classList.remove('dark');
            break;
        default:
            if (mediaQuery) {
                document.body.classList.add('dark');
            }
            break;
    }
</script>



<header>
    <nav class="pt-3 navbar navbar-expand-lg animate">
        <div class="container-fluid mx-xs-2 mx-sm-5 mx-md-5 mx-lg-5">
            
			<a class="navbar-brand primary-font text-wrap" href="/en">
                
                <img src="https://avatars.githubusercontent.com/u/29329312?v=4" width="30" height="30" style="border-radius: 50%"
                    class="d-inline-block align-top">
                Luigi Cennini
                
            </a>
			
				
            
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarContent"
                aria-controls="navbarContent" aria-expanded="false" aria-label="Toggle navigation">
                <svg aria-hidden="true" height="24" viewBox="0 0 16 16" version="1.1" width="24" data-view-component="true">
                    <path fill-rule="evenodd" d="M1 2.75A.75.75 0 011.75 2h12.5a.75.75 0 110 1.5H1.75A.75.75 0 011 2.75zm0 5A.75.75 0 011.75 7h12.5a.75.75 0 110 1.5H1.75A.75.75 0 011 7.75zM1.75 12a.75.75 0 100 1.5h12.5a.75.75 0 100-1.5H1.75z"></path>
                </svg>
            </button>

            
            <div class="collapse navbar-collapse text-wrap primary-font" id="navbarContent">
                <ul class="navbar-nav ms-auto text-center">


                    

                    
					
					<li class="nav-item navbar-text">
						<a class="nav-link" href="/en" aria-label="ita" style=" text-decoration: underline "> 
							eng
						</a>
					</li>
					<li class="nav-item navbar-text">
						<a class="nav-link" href="/it" aria-label="ita" style=""> 
							ita
						</a>
					</li>

                    

                    

                    

                    
                    		
                    
                    <li class="nav-item navbar-text">
                        <a class="nav-link" href="/en/projects" title="projects">
                            
                            projects
                        </a>
                    </li>
                    
                    

                    
                    <li class="nav-item navbar-text">
                        
                        <div class="text-center">
                            <button id="theme-toggle">
                                <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                                </svg>
                                <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <circle cx="12" cy="12" r="5"></circle>
                                    <line x1="12" y1="1" x2="12" y2="3"></line>
                                    <line x1="12" y1="21" x2="12" y2="23"></line>
                                    <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                                    <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                                    <line x1="1" y1="12" x2="3" y2="12"></line>
                                    <line x1="21" y1="12" x2="23" y2="12"></line>
                                    <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                                    <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                                </svg>
                            </button>
                        </div>
                    </li>
                    

                </ul>

            </div>
        </div>
    </nav>
</header>
<div id="content">
<section id="single">
  <div class="container">
    <div class="row justify-content-center">
      <div class="col-sm-12 col-md-12 col-lg-9">
        <div class="pr-lg-4">
          <div class="title mb-5">
            <h1 class="text-center mb-4">fork telemetry</h1>
            <div class="text-center">
              Luigi 
              <small>|</small>
              Apr 3, 2023

              
              <span id="readingTime">
                min read
              </span>
              
            </div>
          </div>
          
          <div class="featured-image">
            <img class="img-fluid" src="/projects/forktelemetry/renders/render.png" alt="fork telemetry">
          </div>
          
          <article class="page-content  p-2">
          <h1 id="introduction">Introduction</h1>
<p>The aim of this project is to develop a cheaper alternative to the telemetry systems available on the market for mountain bikes.</p>
<p>Telemetry systems for mountain bikes monitor and acquire data on the position of the bike&rsquo;s fork and shock absorber while riding. This data is crucial for off-road sports enthusiasts and professional athletes, as it provides valuable information for analysing and improving performance.</p>
<p>Currently, many telemetry systems, such as <a href="https://www.bybtech.it/">byb telemetry</a>, use expensive linear potentiometers to accurately measure the position of the fork and shock absorber.</p>
<p>Other users on the internet have tried other ways to get a good result, for example a <a href="https://www.vitalmtb.com/forums/The-Hub,2/DIY-mtb-telemetry-data,11126">LiDar sensor</a>, but the results were not too encouraging as they were too noisy.</p>
<p>Therefore, after careful evaluation, I have concluded that using a rotary encoder is a more cost-effective alternative.</p>
<p>The main reason for this choice is that rotary encoders are less expensive than linear potentiometers and still offer good position measurement accuracy. In addition, rotary encoders are generally more robust and less prone to damage than linear encoders, which can be more fragile and susceptible to failure in off-road environments.</p>
<h3 id="how-a-rotative-encoder-works">how a rotative encoder works</h3>
<p>Encoders can sense movement in either direction, detecting holes or marks as they move through 2 positions. When the blue disc in the diagram below rotates clockwise, changes are first detected by pin 1 and then pin 2. When it rotates counterclockwise, pin 2 is the first to detect changes. This scheme is called &lsquo;quadrature coding&rsquo; because the waveforms detected by the 2 pins are offset by 90 degrees.</p>

 
<center>
<table class="d-flex justify-content-center">
	<tr>
		<td style="background: none !important; border: none !important">
			<img src="/projects/forktelemetry/td_libs_Encoder_pos1.png" id="quad">
		</td>
	</tr>
	<tr>
		<td align="center" style="background: none !important; border: none !important">
			<form action="#">
				<input type="submit" value="<- counterclockwise" onClick="rotate(-1); return false">
				<input type="text" value="0" id="accum" size=6>
				<input type="submit" value="clockwise ->" onClick="rotate(1); return false">
			</form>
		</td>
	</tr>
</table>
</center>
<script>
var img = new Array();
img[0] = new Image();
img[1] = new Image();
img[2] = new Image();
img[3] = new Image();
img[0].src = "/projects/forktelemetry/td_libs_Encoder_pos1.png";
img[1].src = "/projects/forktelemetry/td_libs_Encoder_pos2.png";
img[2].src = "/projects/forktelemetry/td_libs_Encoder_pos3.png";
img[3].src = "/projects/forktelemetry/td_libs_Encoder_pos4.png";
var position = 0;
function rotate(n) {
val = Number(document.getElementById('accum').value) + n;
if (isNaN(val)) val = 0;
document.getElementById('accum').value = val;
position += n;
if (position > 3) position = 0;
if (position < 0) position = 3;
document.getElementById('quad').src = img[position].src;
}
</script>

<p>(animation taken from <a href="https://www.pjrc.com/teensy/td_libs_Encoder.html">questo sito</a>)</p>
<h1 id="pre---prototyping">pre - prototyping</h1>
<p>Before proceeding with the prototyping of the fork sensor, I carried out a feasibility analysis to assess the feasibility of this project.</p>
<p>As a starting point, I selected a reliable rotary encoder: the LPD3806. This type of encoder offers a resolution of 600 PPR (pulses per revolution). Using a pulley with a diameter of 9.4 mm, a density of approximately 30 detections per millimetre of fork movement is achieved. This is because the encoder generates a quadrature signal that can be read on both the rising and falling edges. By exploiting both edges, we obtain a quadrupled resolution of the encoder, i.e. 24000 PPR (600 PPR * 4).</p>
<p>Calculating the number of possible observations per millimetre of fork movement, we obtain the following result:</p>
<p>$$ \frac{600 * 4}{\pi* 9.4} \approx 30 $$</p>
<p>For example, considering a 150 mm travel fork, there will be approximately 12190 detections (this value will be used in the code).</p>
<p>It is important to note that increasing the diameter of the pulley coupled to the encoder reduces the density of detections per millimetre of movement. Furthermore, the maximum response speed of the encoder must be taken into account, which determines the maximum linear speed that the fork can reach. In the case of the LPD3806, the maximum speed is:</p>
<p>​$$ 2000 RPM = 2000/60 RPS = $$
$$ 2000* (\pi*9.4) /60 \frac{mm}{s} \approx 983 \frac{mm}{s} $$</p>
<p>Using a pulley with a smaller diameter will result in a lower maximum detectable linear speed.</p>
<p>With this initial information, I therefore started the prototyping process.</p>
<h1 id="prototyping">prototyping</h1>
<p>For the prototyping of the fork sensor, I used the <a href="https://www.autodesk.it/products/fusion-360/overview">fusion 360</a> software. After several iterations, I arrived at the following result:</p>

 
<center>
<img src="/projects/forktelemetry/forkSensor.jpg"  width="80%" >
</center>


 
<script type="module" src="/model-viewer.min.js"></script>
<center>
<model-viewer style="width: 80; height: 80vh" src="/projects/forktelemetry/forksensor3d.glb" ar ar-modes="webxr scene-viewer quick-look" camera-controls poster="/projects/forktelemetry/forkSensor3dPoster.webp" shadow-intensity="1" autoplay camera-orbit="-38.89deg 61.4deg 644.1m" field-of-view="30deg">
    <div class="progress-bar hide" slot="progress-bar">
        <div class="update-bar"></div>
    </div>
</model-viewer>
</center>

<p>The fusion360 file is available on GitHub at <a href="https://github.com/giggiox/fork-telemetry/tree/main/fusio360files/v1">this link</a>.
Using <a href="https://www.blender.org/">blender</a> we can also show a concept of how it works once mounted on a fork.</p>

 
<center>
<model-viewer style="width: 80; height: 80vh" src="/projects/forktelemetry/forksensorAnimation.glb" ar ar-modes="webxr scene-viewer quick-look" camera-controls poster="/projects/forktelemetry/forkSensorAnimationPoster.webp" shadow-intensity="1" autoplay camera-orbit="-216.6deg 65.99deg 1356m" field-of-view="30deg">
    <div class="progress-bar hide" slot="progress-bar">
        <div class="update-bar"></div>
    </div>
</model-viewer>
</center>

<p>For the design, I was inspired by the movement of the axes of a 3D printer and integrated a belt tensioning mechanism, typical of this type of printer.</p>
<p>Subsequently, I used the Arduino Nano to create a working Proof of Concept (POC). Overall, the system consists of 2 switches, 1 SD module, 1 Arduino Nano, 1 9-volt battery and the LPD3806 encoder.
Where:</p>
<ul>
<li>a switch is used to turn the system on</li>
<li>The other switch enables the writing of the encoder position with the chosen encoding ([encoder_position,]) to the SD card. This switch must be activated before the start of the descent and switched off immediately afterwards.</li>
</ul>

 
<center>
<img src="/projects/forktelemetry/forktelemetry-schematics.png"  width="60%" >
</center>

<p>At this point, I also designed a capture box using Fusion 360.

 
<center>
<img src="/projects/forktelemetry/openbox_fusion.PNG"  width="80%" >
</center>

The box, which is designed so that it can be fixed with 2 clamps to the top tube of the bike, contains all components (except the encoder) and makes the 2 switches accessible from the outside.

 
<center>
<img src="/projects/forktelemetry/box_fusion.PNG"  width="80%" >
</center>
</p>
<h1 id="stampa-e-codice">stampa e codice</h1>
<p>Once printed (and assembled) the sensor and acquisition box by soldering the components on a millefori</p>

 
<center>
<img src="/projects/forktelemetry/collage.png"  width="80%" >
</center>

<p>the whole thing looks like this:</p>

 
<center>
<img src="/projects/forktelemetry/laydown.jpg"  width="80%" >
</center>

<p>Operation once mounted on the MTB is as follows:</p>

 
<center>
<video width=35% controls>
    <source src="/projects/forktelemetry/video.mp4" type="video/mp4" >
    Your browser does not support the video tag.  
</video>
</center>

<p>The code instead is as follows.
Note that the port manipulation technique was used to obtain a maximum speed in reading the encoder.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;SPI.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;SD.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;String.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#define encoderPinA 3
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define encoderPinB 2
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define buttonPin 7
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define SD_PIN 10
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>File logFile;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">bool</span> enableWriteToSD<span style="color:#f92672">=</span>false;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> newDirectoryName<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> newFileName<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">bool</span> startRecord;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">volatile</span> <span style="color:#66d9ef">long</span> encoderPosition<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">volatile</span> <span style="color:#66d9ef">bool</span> aStatePrev,bStatePrev,aState,bState;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">setup</span>() {
</span></span><span style="display:flex;"><span>  Serial.begin(<span style="color:#ae81ff">9600</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">//setup rotary encoder
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  DDRD <span style="color:#f92672">&amp;=</span> <span style="color:#f92672">~</span>((<span style="color:#ae81ff">1</span> <span style="color:#f92672">&lt;&lt;</span> encoderPinA) <span style="color:#f92672">|</span> (<span style="color:#ae81ff">1</span> <span style="color:#f92672">&lt;&lt;</span> encoderPinB));
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Abilita i pull-up interni
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  PORTD <span style="color:#f92672">|=</span> (<span style="color:#ae81ff">1</span> <span style="color:#f92672">&lt;&lt;</span> encoderPinA) <span style="color:#f92672">|</span> (<span style="color:#ae81ff">1</span> <span style="color:#f92672">&lt;&lt;</span> encoderPinB);
</span></span><span style="display:flex;"><span>  attachInterrupt(digitalPinToInterrupt(encoderPinA),handleEncoderInterrupt,CHANGE);
</span></span><span style="display:flex;"><span>  attachInterrupt(digitalPinToInterrupt(encoderPinB),handleEncoderInterrupt,CHANGE);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">//setup SD
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">if</span>(<span style="color:#f92672">!</span>SD.begin(SD_PIN)){ <span style="color:#66d9ef">while</span>(true); }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">while</span>(SD.exists(String(newDirectoryName))){ newDirectoryName<span style="color:#f92672">++</span>; }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (SD.mkdir(String(newDirectoryName))){
</span></span><span style="display:flex;"><span>    Serial.print(<span style="color:#e6db74">&#34;Created new directory: &#34;</span>);
</span></span><span style="display:flex;"><span>    Serial.println(newDirectoryName);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">//setup record button
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  DDRD <span style="color:#f92672">&amp;=</span> <span style="color:#f92672">~</span>(<span style="color:#ae81ff">1</span> <span style="color:#f92672">&lt;&lt;</span> buttonPin);
</span></span><span style="display:flex;"><span>  PORTD <span style="color:#f92672">|=</span> (<span style="color:#ae81ff">1</span> <span style="color:#f92672">&lt;&lt;</span> buttonPin);
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  Serial.println(<span style="color:#e6db74">&#34;setup completed&#34;</span>);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">loop</span>() {
</span></span><span style="display:flex;"><span>  startRecord<span style="color:#f92672">=</span>PIND<span style="color:#f92672">&amp;</span>(<span style="color:#ae81ff">1</span><span style="color:#f92672">&lt;&lt;</span>buttonPin);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span>(startRecord <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">!</span>enableWriteToSD){
</span></span><span style="display:flex;"><span>    logFile <span style="color:#f92672">=</span> SD.open(String(newDirectoryName) <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;/&#34;</span> <span style="color:#f92672">+</span>  String(newFileName<span style="color:#f92672">++</span>) <span style="color:#f92672">+</span><span style="color:#e6db74">&#34;.txt&#34;</span>, FILE_WRITE);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (logFile) { Serial.println(<span style="color:#e6db74">&#34;Writing to &#34;</span><span style="color:#f92672">+</span> String(newFileName<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>)); }
</span></span><span style="display:flex;"><span>    enableWriteToSD<span style="color:#f92672">=</span>true;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span>(startRecord <span style="color:#f92672">&amp;&amp;</span> enableWriteToSD) {
</span></span><span style="display:flex;"><span>     logFile.print(String(encoderPosition)<span style="color:#f92672">+</span><span style="color:#e6db74">&#34;,&#34;</span>);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span>(<span style="color:#f92672">!</span>startRecord <span style="color:#f92672">&amp;&amp;</span> enableWriteToSD){
</span></span><span style="display:flex;"><span>    enableWriteToSD<span style="color:#f92672">=</span>false;
</span></span><span style="display:flex;"><span>    logFile.close();
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">handleEncoderInterrupt</span>(){
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Leggi lo stato corrente dei segnali A e B
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  aState <span style="color:#f92672">=</span> PIND <span style="color:#f92672">&amp;</span> (<span style="color:#ae81ff">1</span> <span style="color:#f92672">&lt;&lt;</span> encoderPinA);
</span></span><span style="display:flex;"><span>  bState <span style="color:#f92672">=</span> PIND <span style="color:#f92672">&amp;</span> (<span style="color:#ae81ff">1</span> <span style="color:#f92672">&lt;&lt;</span> encoderPinB);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Verifica se il fronte di salita è avvenuto sul segnale A
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">if</span> (aState <span style="color:#f92672">!=</span> aStatePrev) {
</span></span><span style="display:flex;"><span>    aStatePrev <span style="color:#f92672">=</span> aState;
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Verifica il cambiamento di direzione dell&#39;encoder
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> (aStatePrev <span style="color:#f92672">==</span> bStatePrev) {
</span></span><span style="display:flex;"><span>      encoderPosition<span style="color:#f92672">--</span>;
</span></span><span style="display:flex;"><span>    } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>      encoderPosition<span style="color:#f92672">++</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Memorizza lo stato corrente dei segnali A e B per il prossimo interrupt
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  bStatePrev <span style="color:#f92672">=</span> bState;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h1 id="first-tests-and-results">first tests and results</h1>
<p>When the switch is activated, the code starts recording the encoder position and saves it in a log file in its folder. The log file contains the encoder position values separated by commas.</p>
<p>I have created a website in javascript that uses the <a href="https://plotly.com/javascript/">Plotly JS</a> library to display this data (<a href="https://github.com/giggiox/fork-telemetry/tree/main/web">GitHub link to site code</a>). For example, the video I showed earlier produces a log file that can be opened in the site and generates this output:</p>

 
<center>
<img src="/projects/forktelemetry/plot.png"  width="80%" >
</center>

<p>The scatter plot shows the sampling number on the abscissas and the fork compression in millimetres on the ordinates.</p>
<p>Below the graph there are also tabular data indicating the number of bottom-outs recorded (none here), the most frequent value of fork compression and the percentage of fork used (here over 26 mm on a 150 mm fork, i.e. around 18%).</p>
<h3 id="telemetry-display-on-screen">telemetry display on screen</h3>
<p>I have also created a python script (<a href="https://github.com/giggiox/fork-telemetry/blob/main/videoEdit.ipynb">GitHub link to script</a>) which is based on <a href="https://pypi.org/project/Pillow/">Pillow</a> and <a href="https://pypi.org/project/opencv-python/">cv2</a>.
This script allows you to insert the telemetry detected on a video, which for the video I showed earlier, produces an effect similar to this:</p>

 
<center>
<video width=35% controls>
    <source src="/projects/forktelemetry/videoTelemetry.mp4" type="video/mp4" >
    Your browser does not support the video tag.  
</video>
</center>

<p>This script first creates 101 images of the rectangle with the percentage written inside (0% to 100%). It then puts these images together in a video where each image represents a value measured by the sensor.</p>
<h1 id="field-tests">field tests</h1>
<p>When I tested the system on a real enduro descent, I encountered the first difficulties and restrictions of the hardware I used (especially the arduino). In fact, if the shocks are too fast, the pulse count coming from the encoder starts to &lsquo;drift&rsquo; and become increasingly negative.</p>

 
<center>
<img src="/projects/forktelemetry/testSulCampo.PNG"  width="80%" >
</center>

<p>This is because the encoder frequency ranges from 0 to 20KHz.
This implies that there is at least a 50 microsecond interval between one rising edge and another.
Assuming that only the rising edges of signal A are read (thus lowering the accuracy estimate made earlier by a quarter), the arduino still cannot do all the necessary operations in this short time.
In fact it should</p>
<ul>
<li>do a <code>digitalRead()</code> on the signal pin B</li>
<li>write the position on the SD</li>
</ul>
<p>In the next 2 I try to examine the code and explain why the arduino is not the correct hardware to proceed.</p>
<h2 id="digitalread">digitalRead</h2>
<p>For example let&rsquo;s look at how long a digitalRead() takes using port manipulation.
We can for example take this arduino code that does a digitalRead() of encoderPinB and if it is HIGH then it adds 1 to encoderPosition, otherwise it decreases the variable by 1.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">handleEncoderInterrupt</span>(){
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Leggi lo stato corrente del segnale B
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  PIND <span style="color:#f92672">&amp;</span> (<span style="color:#ae81ff">1</span> <span style="color:#f92672">&lt;&lt;</span> encoderPinB) <span style="color:#f92672">?</span> encoderPosition <span style="color:#f92672">+=</span><span style="color:#ae81ff">1</span> <span style="color:#f92672">:</span> encoderPosition <span style="color:#f92672">-=</span><span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>and decompile it <code>C:\Users\luigi\AppData\Local\Temp\arduino_build_211859&gt;&quot;C:\Program Files (x86)\Arduino\hardware\tools\avr\bin\avr-objdump.exe&quot; -S codice_test.ino.elf</code></p>
<p>ottenendo</p>
<pre tabindex="0"><code class="language-assembly" data-lang="assembly">a8:   4a 9b           sbis    0x09, 2 ; 9
aa:   0c c0           rjmp    .+24            ; 0xc4 &lt;_Z22handleEncoderInterruptv+0x1c&gt;
ac:   80 91 04 01     lds     r24, 0x0104     ; 0x800104 &lt;__data_end&gt;
b0:   90 91 05 01     lds     r25, 0x0105     ; 0x800105 &lt;__data_end+0x1&gt;
b4:   a0 91 06 01x     lds     r26, 0x0106     ; 0x800106 &lt;__data_end+0x2&gt;
b8:   b0 91 07 01     lds     r27, 0x0107     ; 0x800107 &lt;__data_end+0x3&gt;
bc:   01 96           adiw    r24, 0x01       ; 1
be:   a1 1d           adc     r26, r1
c0:   b1 1d           adc     r27, r1
c2:   0b c0           rjmp    .+22            ; 0xda &lt;_Z22handleEncoderInterruptv+0x32&gt;
c4:   80 91 04 01     lds     r24, 0x0104     ; 0x800104 &lt;__data_end&gt;
c8:   90 91 05 01     lds     r25, 0x0105     ; 0x800105 &lt;__data_end+0x1&gt;
cc:   a0 91 06 01     lds     r26, 0x0106     ; 0x800106 &lt;__data_end+0x2&gt;
d0:   b0 91 07 01     lds     r27, 0x0107     ; 0x800107 &lt;__data_end+0x3&gt;
d4:   01 97           sbiw    r24, 0x01       ; 1
d6:   a1 09           sbc     r26, r1
d8:   b1 09           sbc     r27, r1
da:   80 93 04 01     sts     0x0104, r24     ; 0x800104 &lt;__data_end&gt;
de:   90 93 05 01     sts     0x0105, r25     ; 0x800105 &lt;__data_end+0x1&gt;
e2:   a0 93 06 01     sts     0x0106, r26     ; 0x800106 &lt;__data_end+0x2&gt;
e6:   b0 93 07 01     sts     0x0107, r27     ; 0x800107 &lt;__data_end+0x3&gt;
ea:   08 95           ret
</code></pre><p>In particular, the instructions that do the digital readout of encoderPinB are the 2nd to 6th, i.e. the 4 instructions that use <code>lds</code> (Load direct from SRAM).
From the <a href="https://ww1.microchip.com/downloads/en/DeviceDoc/Atmel-7810-Automotive-Microcontrollers-ATmega328P_Datasheet.pdf">ATmega328 datasheet (page 283)</a> we can see that these instructions take exactly 2 clock cycles.</p>

 
<center>
<img src="/projects/forktelemetry/datasheet.PNG"  width="80%" >
</center>

<p>So being a 16Mhz microcontroller (1 clock cycle takes 1/16,000,000th of a second, or 62.5 nanoseconds), then those 4 instructions take 8 cycles * 62.5 ns/cycle = 500 ns.</p>
<p>From this analysis, it can be deduced that digitalRead() is not the bottleneck in the code.</p>
<h2 id="write-to-sd">write to SD</h2>
<p>Instead, let&rsquo;s look at how long a write to the SD takes. To get a more or less approximate number, we can for example print out the number of milliseconds before and after the position is written to memory.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>Serial.println(millis());
</span></span><span style="display:flex;"><span>logFile.print(String(encoderPosition)<span style="color:#f92672">+</span><span style="color:#e6db74">&#34;,&#34;</span>);
</span></span><span style="display:flex;"><span>Serial.println(millis());
</span></span></code></pre></div><p>And we can see that indeed the bottleneck is in this call, which can take up to 200 milliseconds. Of course, this time also depends on the SD used.</p>
<h1 id="future-developments">future developments</h1>
<ul>
<li>use a microcontroller with several cores, e.g. an esp32 where one core takes care of reading the encoder signal and another takes care of sampling (which can then be done constantly e.g. 1000 times per second) and writing the encoder position to the SD.</li>
<li>use a Bluetooth module to communicate data to an android application, also in real time.</li>
<li>add a GPS module so that you can have in the analysis panel not only the position of the fork metre by metre but also the position of the rider along the descent.</li>
<li>sensor redesign. The first design I did was top-down (also because it was the first time I had used fusion360 and also the first time I had really created something functional) and with box shapes (not structurally strong) and a lot can be improved. For example, using a linear guide can reduce the complexity of the sensor (and also the weight) but also the degrees of freedom of the system. Below is a possible v2 design using a 6mm linear guide.</li>
</ul>
<p>
 
<center>
<img src="/projects/forktelemetry/rev2.PNG"  width="80%" >
</center>

The fusion360 file for this version is available on GitHub at <a href="https://github.com/giggiox/fork-telemetry/tree/main/fusio360files/v2">this link</a> .</p>

          </article>
        </div>
      </div>
      
	  
	  
	  
	  
    
	
	
	
	
	
	
	
	
	
	
	</div>
    <div class="row">
      <div class="col-sm-12 col-md-12 col-lg-9 p-4">
        
      </div>
    </div>
  </div>
  <button class="p-2 px-3" onclick="topFunction()" id="topScroll">
    <i class="fas fa-angle-up"></i>
  </button>
</section>


<div class="progress">
  <div id="scroll-progress-bar" class="progress-bar" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
</div>
<Script src="/js/scrollProgressBar.js"></script>


<script>
  var topScroll = document.getElementById("topScroll");
  window.onscroll = function() {scrollFunction()};

  function scrollFunction() {
    if (document.body.scrollTop > 20 || document.documentElement.scrollTop > 20) {
      topScroll.style.display = "block";
    } else {
      topScroll.style.display = "none";
    }
  }

  function topFunction() {
    document.body.scrollTop = 0;
    document.documentElement.scrollTop = 0;
  }
</script>


<script src="/js/readingTime.js"></script>



  </div><footer>

    <div class="container py-4">
    <div class="row justify-content-center">
        <div class="col-md-4 text-center">
            
            &copy; 2023  All rights reserved
            <div class="text-secondary">
                Made with
                <span class="text-danger">
                    &#10084;
                </span>
                and
                <a href="https://github.com/gurusabarish/hugo-profile" target="_blank"
                    title="Designed and developed by gurusabarish">
                    Hugo Profile
                </a>
            </div>
        </div>
    </div>
</div></footer><script src="/bootstrap-5/js/bootstrap.bundle.min.js"></script>
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl)
    })

</script>


    <script src="/js/search.js"></script>





<!-- MathJax -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.2/es5/tex-mml-chtml.min.js" integrity="sha384-M5jmNxKC9EVnuqeMwRHvFuYUE8Hhp0TgBruj/GZRkYtiMrCRgH7yvv5KY+Owi7TW" crossorigin="anonymous"></script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {
        inlineMath: [['\\(','\\)']],
        displayMath: [['$$','$$'], ['\[','\]']],
        processEscapes: true,
        processEnvironments: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
        TeX: { equationNumbers: { autoNumber: "AMS" },
             extensions: ["AMSmath.js", "AMSsymbols.js"] }
      }
    });
</script>





  <section id="search-content" class="py-2">
    <div class="container" id="search-results"></div>
  </section>
</body>

</html>