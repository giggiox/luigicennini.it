[{"content":"\u003ch1 id=\"bézier-curves\"\u003eBézier Curves\u003c/h1\u003e\n\u003cp\u003eBézier curves are a fundamental concept in computer graphics and vector drawing. They are used to describe curves by controlling points called \u0026lsquo;control points\u0026rsquo;.\nThese curves were introduced by Pierre Bézier in the 1960s as a method of representing curves on computer screens.\nA Bézier curve has the form\u003c/p\u003e\n\u003cp\u003e$$\\underline{x}(t) = \\sum_{i=0}^n \\underline{b}_i B_i^n(t), t\\in[0,1]$$\u003c/p\u003e\n\u003cp\u003eWhere,\u003c/p\u003e\n\u003cp\u003e$$B_i^n(t) = {n \\choose i}t^i(1-t)^{n-i}, i= 0,\u0026hellip;,n$$\u003c/p\u003e\n\u003cp\u003eare the n+1 basic Bernstein polynomials.\u003c/p\u003e\n\u003cp\u003eNIn the editor below, I have implemented an interactive version of these curves.\nThe algorithms I have implemented are the curve computation algorithm or the \u003cstrong\u003ede Casteljau algorithm\u003c/strong\u003e and the degree elevation algorithm.\u003c/p\u003e\n\u003cp\u003eEditor instructions:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e2 left-clicks to add a new control point\u003c/li\u003e\n\u003cli\u003emove control points by dragging while holding down the left mouse button\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cstrong\u003eWarning\u003c/strong\u003e: If you are not correctly seeing (or not seeing) the sketch below correctly, visit \u003ca href=\"https://editor.p5js.org/giggiox/full/nyiLHZ80x\"\u003ethis link\u003c/a\u003e. Or \u003ca href=\"https://editor.p5js.org/giggiox/sketches/nyiLHZ80x\"\u003ethis link\u003c/a\u003e to see and edit the source code.\u003c/p\u003e\n\r\n \r\n\u003cscript src=\"/p5.min.js\"\u003e\u003c/script\u003e\r\n\u003cscript src=\"/math.js\"\u003e\u003c/script\u003e\r\n\n\r\n \r\n\u003cdiv id =\"thirdCanvas\" \u003e\u003c/div\u003e\r\n\r\n\u003cdiv class=\"container text-center\" id=\"forWidth\"\u003e\r\n\t\u003cdiv class=\"row\"\u003e\r\n\t\t\t\r\n\t\t\u003cdiv class=\"col-sm-5 col-md-6\" id =\"sliderCol3\"\u003e\r\n\t\tt\r\n\t\t\u003c/div\u003e\r\n\t\t\r\n\t\t\u003cdiv class=\"col-sm-5 offset-sm-2 col-md-6 offset-md-0\" id =\"granularity3\"\u003e\r\n\t\tgranularity\r\n\t\t\u003c/div\u003e\r\n\t\t\r\n\t\u003c/div\u003e\r\n\u003c/div\u003e\r\n\u003cdiv class=\"container text-center\"\u003e\r\n\t\u003cdiv class=\"row\"\u003e\r\n\t\t\u003cdiv class=\"col-sm-5 col-md-6\"\u003e\r\n\t\t\tauto play\r\n\t\t\t\u003cbr\u003e\r\n\t\t\t\u003cdiv class=\"checkbox-wrapper-6\" id=\"autoPlay3\" style=\"display: inline-block;\"\u003e\r\n\t\t\t  \u003cinput class=\"tgl tgl-light\" id=\"cb1-6\" type=\"checkbox\" /\u003e\r\n\t\t\t  \u003clabel class=\"tgl-btn\" for=\"cb1-6\"\u003e\r\n\t\t\t\u003c/div\u003e\r\n\t\t\t\r\n\t\t\u003c/div\u003e\r\n\t\t\u003cdiv class=\"col-sm-5 col-md-6\"\u003e\r\n\t\t\tshow control polygon\r\n\t\t\t\u003cbr\u003e\r\n\t\t\t\u003cdiv class=\"checkbox-wrapper-6\" id=\"controlPolygon1\" style=\"display: inline-block;\"\u003e\r\n\t\t\t  \u003cinput class=\"tgl tgl-light\" id=\"cb1-8\" type=\"checkbox\" checked/\u003e\r\n\t\t\t  \u003clabel class=\"tgl-btn\" for=\"cb1-8\"\u003e\r\n\t\t\t\u003c/div\u003e\t\t\t\r\n\t\t\u003c/div\u003e\r\n\t\u003c/div\u003e\r\n\t\u003cdiv class=\"row\"\u003e\r\n\t\t\u003cdiv class=\"col-sm-5 col-md-6\"\u003e\r\n\t\t\tshow construct lines\r\n\t\t\t\u003cbr\u003e\r\n\t\t\t\u003cdiv class=\"checkbox-wrapper-6\" id=\"constructLines1\" style=\"display: inline-block;\"\u003e\r\n\t\t\t  \u003cinput class=\"tgl tgl-light\" id=\"cb1-7\" type=\"checkbox\" checked/\u003e\r\n\t\t\t  \u003clabel class=\"tgl-btn\" for=\"cb1-7\"\u003e\r\n\t\t\t\u003c/div\u003e\t\t\t\r\n\t\t\u003c/div\u003e\r\n\t\t\r\n\t\t\u003cdiv class=\"col-sm-5 offset-sm-2 col-md-6 offset-md-0\"\u003e\r\n\t\t\t\u003cbutton class=\"button button2\" id=\"degreeElevation3\"\u003edegree elevation\u003c/button\u003e\r\n\t\t\u003c/div\u003e\r\n\t\u003c/div\u003e\r\n\u003c/div\u003e\r\n\r\n\r\n\u003cscript\u003e\r\nvar secondSketch = function(sketch){\r\n\r\n\tvar bezierCurve;\r\n\tvar slider; var sliderMax = 100;\r\n\tvar checkBoxAutoPlay;  let checkedBoxAutoPlay = false;let addToSlider = 1;\r\n\tvar checkBoxShowConstructLines;\r\n\tvar checkBoxShowControlPolygonLines;\r\n\tvar checkBoxShowCurveTrace;\r\n\tvar checkBoxShowConstructPoints;\r\n\tvar granularity,button,button1;\r\n\r\n\tvar canvasResizeFactor = 1.6;\r\n\r\n\tsketch.setup = function(){\r\n\t\tbezierCurve = new BezierCurve([[sketch.windowWidth/canvasResizeFactor/1.5,sketch.windowHeight/canvasResizeFactor/3],\r\n\t\t\t\t\t\t\t\t\t\t[sketch.windowWidth/canvasResizeFactor/4,sketch.windowHeight/canvasResizeFactor/1.1]]);\r\n\t\tsketch.frameRate(40); //change this for the slider autoplay velocity\r\n\t\r\n\t\r\n\t\tlet width = document.getElementById(\"forWidth\").offsetWidth;\r\n\t\tvar myCanvas = sketch.createCanvas(width, sketch.windowHeight/1.6);\r\n\t\t/* check for double click since p5js does not offer a Canvas.mouseDoubleClick but only a canvas.mouseClick. Using the function doubleClicked of p5js does not work because it's global and with more than 1 canvas on a page it gets mad */\r\n\t\tdocument.getElementById(\"thirdCanvas\").addEventListener('dblclick', doubleClick);\r\n\t\t\r\n\t\t//document.getElementById(\"thirdCanvas\").addEventListener('contextmenu',leftClick);\r\n\t\tdocument.getElementById('thirdCanvas').addEventListener('contextmenu',event =\u003e event.preventDefault()); //remove the window menu for right click\r\n\t\t\r\n\t\tslider = sketch.createSlider(0, sliderMax, 1);\r\n\t\tslider.parent(\"sliderCol3\");\r\n\t\tslider.addClass(\"myslider\");\r\n\t\tslider.value(sliderMax);\r\n\t\t\r\n\t\tgranularity = sketch.createSlider(10, 500, 400);\r\n\t\tgranularity.addClass(\"myslider\");\r\n\t\tgranularity.parent(\"granularity3\");\r\n\t\t\r\n\t\t\r\n\t\tdocument.getElementById(\"autoPlay3\").addEventListener('change',myEventCheckBoxAutoPlay);\r\n\t\tdocument.getElementById(\"degreeElevation3\").addEventListener('click',myEventDegreeElevation);\r\n\t\t\r\n\t\tdocument.getElementById(\"constructLines1\").addEventListener('change',myEventShowConstructLines);\r\n\t\tdocument.getElementById(\"controlPolygon1\").addEventListener('change',myEventShowControlPolygon);\r\n\r\n\t}\r\n\r\n\tsketch.draw = function() {\r\n\t\t//sketch.clear();\r\n\t\t//sketch.background(220, 10);\r\n\t\tsketch.background(250);\r\n\t\tbezierCurve.changeGranularity(granularity.value());\r\n\t\tif(checkedBoxAutoPlay){\r\n\t\t\tif(slider.value() == sliderMax) addToSlider = -1;\r\n\t\t\tif(slider.value() == 0 \u0026\u0026 addToSlider \u003c 0 ) addToSlider = 1;\r\n\t\t\tslider.value((slider.value()+addToSlider)); \r\n\t\t}\r\n\t\tbezierCurve.render(); \r\n\t}\r\n\t\r\n\t\r\n\t\r\n\t\r\n\tclass ConstructLine{\r\n\t  \r\n\t  constructor(p1 = null,p2 = null) {\r\n\t\tthis.p1 = p1;\r\n\t\tthis.p2 = p2;\r\n\t\t\r\n\t  }\r\n\t  render() {\r\n\t\t\t//stroke(126);\r\n\t\t\tsketch.strokeWeight(1.5);\r\n\t\t\tsketch.line(this.p1.x,this.p1.y,this.p2.x,this.p2.y);\r\n\t  }\r\n\t  \r\n\t}\r\n\t\r\n\r\n\t\r\n\tfunction mapSpace(x,in_min, in_max,out_min,out_max) {\r\n\t\treturn (x - in_min) * (out_max - out_min) / (in_max - in_min) + out_min;\r\n\t}\r\n\r\n\tfunction linspace(startValue, stopValue, cardinality) {\r\n\t\tvar arr = [];\r\n\t\tvar step = (stopValue - startValue) / (cardinality - 1);\r\n\t\tfor (var i = 0; i \u003c cardinality; i++) {\r\n\t\t\tarr.push(startValue + (step * i));\r\n\t\t}\r\n\t\treturn arr;\r\n\t}\r\n\t\r\n\tclass BezierCurve{\r\n\t  constructor(points = []) {\r\n\t\t//TODO add the possibility to create a curve passing arguments\r\n\t\t\r\n\t\t\r\n\t\tthis.controlPoints = [];\r\n\t\tthis.draggedControlPointIndex = -1; // by convention = -1 if we are not dragging any point\r\n\t\t\r\n\t\tthis.controlPointsX = [];\r\n\t\tthis.controlPointsY = [];\r\n\t\t\r\n\t\tthis.granularity = 1000;\r\n\t\tthis.t = linspace(0,1,this.granularity);\r\n\t\t\r\n\t\tthis.constructLines = [];\r\n\t\tthis.constructPoints = [];\r\n\t\tthis.controlPolygonLines = [];\r\n\t\t\r\n\t\tthis.checkedShowControlPolygon = true;\r\n\t\tthis.checkedShowConstructLines = true;\r\n\t\tthis.checkedShowCurveTrace = true;\r\n\t\tthis.checkedShowConstructPoints = true;\r\n\t\t\r\n\t\t\r\n\t\tif(points.length != 0){\r\n\t\t\tfor(let i = 0; i\u003cpoints.length; i++){\r\n\t\t\t\tthis.addControlPoint(points[i][0],points[i][1]);\r\n\t\t\t}\r\n\t\t}\r\n\t\t\r\n\t\t\r\n\t\t\r\n\t\t\r\n\t\t\r\n\t  }\r\n\t  \r\n\t  \r\n\t  degreeElevation(){\r\n\t\tlet lastX, lastY, n;\r\n\t\tn = this.controlPoints.length-1;\r\n\t\tlastX = this.controlPoints[n].x;\r\n\t\tlastY = this.controlPoints[n].y;\r\n\t\t//cant do in place because changing b_i in one iteration then the next cant retrive true b_i value\r\n\t\t//using duplicate copys of coordinates (required extra loop) to do it easily\r\n\t\t\r\n\t\tfor(let i = 1; i \u003c= n; i++){\r\n\t\t  this.controlPoints[i].x = i/(n+1) * this.controlPointsX[i-1] + (n-i+1)/(n+1)*this.controlPointsX[i];\r\n\t\t  this.controlPoints[i].y = i/(n+1) * this.controlPointsY[i-1] + (n-i+1)/(n+1)*this.controlPointsY[i];\r\n\t\t  \r\n\t\t}\r\n\t\tfor(let i=0;i\u003c=n; i++){\r\n\t\t  this.controlPointsX[i] = this.controlPoints[i].x;\r\n\t\t  this.controlPointsY[i] = this.controlPoints[i].y;\r\n\t\t}\r\n\t\tthis.addControlPoint(lastX,lastY);\r\n\t\t\r\n\t\t\r\n\t  }\r\n\t  \r\n\t  changeGranularity(x){\r\n\t\tthis.granularity = x;\r\n\t\tthis.t = linspace(0,1,x);\r\n\t  }\r\n\t\t\r\n\t  \r\n\t\t\r\n\t\t\r\n\t  addControlPoint(x,y){\r\n\t\tthis.controlPoints.push(new ConstructPoint(x,y,6));\r\n\t\tthis.controlPointsX.push(x);\r\n\t\tthis.controlPointsY.push(y);\r\n\t\t\r\n\t\t\r\n\t\tlet n = this.controlPoints.length;\r\n\t\t\r\n\t\t//number of constructPoint (interpolating points) goes as triangular sequence\r\n\t\t//0,1,3,6,10,15,... = n(n+1)/2\r\n\t\t//for n= 0 (1 control points) -\u003e 0 interpolating points\r\n\t\t//for n= 1 (2 control points)-\u003e 1 interpolating points\r\n\t\t//for n= 2 (3 control points) -\u003e 3 interpolating points\r\n\t\t//for n = 3 (4 control points) -\u003e 6 interpolating points\r\n\t\t//and so on\r\n\t\tfor(let i = 0; i \u003c (n*(n+1)/2 - this.constructPoints.length)-1;i++){\r\n\t\t  this.constructPoints.push(new ConstructPoint(x,y));\r\n\t\t}\r\n\t\t\r\n\t\t\r\n\t\t//number of constructLines goes as triangular sequence but with n-1 so (n-1)*(n)/2\r\n\t\t//for n= 0 (1 control points) -\u003e 0 interpolating lines\r\n\t\t//for n= 1 (2 control points)-\u003e 0 interpolating lines\r\n\t\t//for n= 2 (3 control points) -\u003e 1 interpolating lines\r\n\t\t//for n = 3 (4 control points) -\u003e 3 interpolating lines\r\n\t\t//for n = 4 (5 control points) -\u003e 6 interpolating lines\r\n\t\t//and so on\r\n\t\tfor(let i = 0; i\u003c ((n-1)*n/2 - this.constructLines.length)-1; i++){\r\n\t\t  this.constructLines.push(new ConstructLine(this.controlPoints[this.controlPoints.length-2],this.controlPoints[this.controlPoints.length-3]));\r\n\t\t}\r\n\t\t\r\n\t\t\r\n\r\n\t\t//add Control polygon lines\r\n\t\tif(n\u003e1){\r\n\t\t  this.controlPolygonLines.push(new ConstructLine(this.controlPoints[this.controlPoints.length-2],this.controlPoints[this.controlPoints.length-1]));\r\n\t\t}\r\n\t\t\r\n\t\t\r\n\t\t\r\n\t  }\r\n\t  \r\n\t  showConstructPoints(){\r\n\t\tthis.checkedShowConstructPoints = !this.checkedShowConstructPoints;\r\n\t  }\r\n\t  \r\n\t  //change visibility of the control polygon\r\n\t  showControlPolygon(){\r\n\t\tthis.checkedShowControlPolygon = !this.checkedShowControlPolygon;\r\n\t  }\r\n\t  //change visibility of construct lines (interpolating lines)\r\n\t  showConstructLines(){\r\n\t\tthis.checkedShowConstructLines = !this.checkedShowConstructLines;\r\n\t  }\r\n\t  \r\n\t  //change visibility of curve trace\r\n\t  showCurveTrace(){\r\n\t\tthis.checkedShowCurveTrace = ! this.checkedShowCurveTrace;\r\n\t  }\r\n\t  \r\n\t  //calculate de casteljau algorithm\r\n\t  calcBezierPoint(t){\r\n\t\t\r\n\t\tif(this.controlPoints.length == 0){ return null; }\r\n\t\t\r\n\t\t//copy control points coordinate because with them moving, can't make \r\n\t\t//in place replace\r\n\t\tlet controlPointsXCopy = [...this.controlPointsX]; \r\n\t\tlet controlPointsYCopy = [...this.controlPointsY];\r\n\t\tlet k = 0; let m = 0;\r\n\t\tfor(let i = 0; i\u003c this.controlPoints.length-1; i++){\r\n\t\t  for(let j = 0; j\u003cthis.controlPoints.length-i-1; j++){\r\n\t\t\tcontrolPointsXCopy[j] = (1-t)*controlPointsXCopy[j] + t*controlPointsXCopy[j+1];        \r\n\t\t\tcontrolPointsYCopy[j] = (1-t)*controlPointsYCopy[j] + t*controlPointsYCopy[j+1];\r\n\r\n\t\t\t\r\n\t\t\t\r\n\t\t\tthis.constructPoints[k].x = controlPointsXCopy[j];\r\n\t\t\tthis.constructPoints[k].y = controlPointsYCopy[j];\r\n\t\t\t\r\n\t\t\tif(j\u003e0){\r\n\t\t\t  this.constructLines[m].p1 = this.constructPoints[k];\r\n\t\t\t  this.constructLines[m].p2 = this.constructPoints[k-1];\r\n\t\t\t  m+=1;\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\tk += 1;\r\n\t\t  }\r\n\t\t}\r\n\t\treturn [controlPointsXCopy[0], controlPointsYCopy[0]]\r\n\t\t\r\n\t  }\r\n\t  \r\n\t  mousePressedAction(){\r\n\t\tfor (let i = 0; i \u003c this.controlPoints.length; i++) {\r\n\t\t  let vertexUI = this.controlPoints[i];\r\n\t\t  \r\n\t\t  if(vertexUI.hasInside(sketch.mouseX,sketch.mouseY)){\r\n\t\t\tthis.draggedControlPointIndex = i;\r\n\t\t  }\r\n\t\t}\r\n\t\t\r\n\t  }\r\n\t  \r\n\t  mouseDraggedAction(){\r\n\t\tif (this.draggedControlPointIndex == -1)\r\n\t\t\t\treturn;\r\n\t\tlet newMouseX = sketch.mouseX;\r\n\t\tlet newMouseY = sketch.mouseY;\r\n\t\t\r\n\t\tthis.controlPoints[this.draggedControlPointIndex].x = newMouseX;\r\n\t\tthis.controlPoints[this.draggedControlPointIndex].y = newMouseY;\r\n\t\tthis.controlPointsX[this.draggedControlPointIndex] = newMouseX;\r\n\t\tthis.controlPointsY[this.draggedControlPointIndex] = newMouseY;\r\n\t\t\r\n\t  }\r\n\t   mouseReleasedAction() {\r\n\t\t\tthis.draggedControlPointIndex = -1;\r\n\t\t}\r\n\t  \r\n\t  \r\n\t  render(){\r\n\t\t\r\n\t\t\r\n\t  \r\n\t\tfor(let i = 0; i \u003c this.controlPoints.length; i++){\r\n\t\t  this.controlPoints[i].render();\r\n\t\t}\r\n\t\t\r\n\t\t\r\n\t\t//commented because this draws the whole curve without accounting the slider\r\n\t\t/*for(let i = 0; i\u003c this.t.length; i++){\r\n\t\t  \r\n\t\t  let tmp = this.calcBezierPoint(this.t[i]);\r\n\t\t  if(tmp != null){\r\n\t\t\t//console.log(tmp[0] + \"  \" + tmp[1]);\r\n\t\t\tstroke(0);\r\n\t\t\tstrokeWeight(2);\r\n\t\t\tellipse(tmp[0],tmp[1], 1, 1);\r\n\t\t  }\r\n\t\t}*/\r\n\t\t\r\n\t\t//the slider.value() != 0 removes imperfections in visualization. (overlapping lines or points not returning to the begininning)\r\n\t\tif(this.checkedShowConstructPoints \u0026\u0026 slider.value() != 0 \u0026\u0026 slider.value() != sliderMax){\r\n\t\t  for(let i = 0; i\u003c this.constructPoints.length; i++){\r\n\t\t\tthis.constructPoints[i].render();\r\n\t\t  }\r\n\t\t}\r\n\t\t\r\n\t\tif(this.checkedShowConstructLines \u0026\u0026 slider.value() != 0 \u0026\u0026 slider.value() != sliderMax){\r\n\t\t  for(let i = 0; i\u003c this.constructLines.length; i++){\r\n\t\t\tthis.constructLines[i].render();\r\n\t\t  }\r\n\t\t}\r\n\t\t\r\n\t\tif(this.checkedShowControlPolygon){\r\n\t\t  for(let i = 0; i\u003c this.controlPolygonLines.length; i++){\r\n\t\t\tthis.controlPolygonLines[i].render();\r\n\t\t  }\r\n\t\t}\r\n\t  \r\n\t  \r\n\t\t\r\n\t\tfor(let i = 0; i\u003c mapSpace(slider.value(),0,100,0,this.granularity); i++){\r\n\t\t  let tmp = this.calcBezierPoint(this.t[i]);\r\n\t\t  if(tmp != null \u0026\u0026  this.checkedShowCurveTrace){\r\n\t\t\tsketch.strokeWeight(1.5);\r\n\t\t\tsketch.stroke(\"blue\");\r\n\t\t\tsketch.point(tmp[0],tmp[1]);\r\n\t\t  }\r\n\t\t}\r\n\t  }\r\n\t}\r\n\t\r\n\t\r\n\t\r\n\tclass ConstructPoint{\r\n\t\tconstructor(x = null, y = null,radius = 3) {\r\n\t\t\tthis.x = x;\r\n\t\t\tthis.y = y;\r\n\t\t\tthis.radius = radius;\r\n\t\t\tthis.grabbableRadius = radius + 4;\r\n\t\t}\r\n\t\trender() {\r\n\t\t\tsketch.stroke(0);\r\n\t\t\tsketch.strokeWeight(5);\r\n\t\t\tsketch.ellipse(this.x,this.y, this.radius, this.radius);\r\n\t\t}  \r\n\t\t\r\n\t\t/**\r\n\t\thasInside only used for a point that is a bezier control point. We need to know if the mouse is inside in order to move it.\r\n\t\t\r\n\t\t**/\r\n\t\thasInside(x, y) {\r\n\t\t\tlet distance = sketch.dist(this.x, this.y, x, y);\r\n\t\t\treturn distance \u003c= this.grabbableRadius; \r\n\t\t\t\r\n\t\t}\r\n\t}\r\n\t\r\n\tfunction doubleClick(){\r\n\t\tbezierCurve.addControlPoint(sketch.mouseX,sketch.mouseY);\r\n\t}\r\n\t\r\n\tsketch.mousePressed = function(){\r\n\t  bezierCurve.mousePressedAction();\r\n\t}\r\n\r\n\tsketch.mouseDragged = function(){\r\n\t  bezierCurve.mouseDraggedAction();\r\n\t}\r\n\r\n\tsketch.mouseReleased = function(){\r\n\t  bezierCurve.mouseReleasedAction()\r\n\t}\r\n\t\r\n\tsketch.windowResized = function(){ \r\n\t\tlet width = document.getElementById(\"forWidth\").offsetWidth;\r\n\t\tsketch.resizeCanvas(width,sketch.widowHeight/1.6);\r\n\t}\r\n\t\r\n\tfunction myEventCheckBoxAutoPlay(){\r\n\t  checkedBoxAutoPlay = !checkedBoxAutoPlay;\r\n\t}\r\n\r\n\tfunction myEventCheckBoxShowCurveTrace(){\r\n\t  bezierCurve.showCurveTrace();\r\n\t}\r\n\r\n\tfunction myEventDegreeElevation(){\r\n\t  bezierCurve.degreeElevation();\r\n\t}\r\n\r\n\tfunction myEventChangeGranularity(){\r\n\t  bezierCurve.changeGranularity(granularity.value());\r\n\t}\r\n\t\r\n\tfunction myEventShowConstructLines(){\r\n\t\tbezierCurve.showConstructLines();\r\n\t\tbezierCurve.showConstructPoints()\r\n\t}\r\n\t\r\n\tfunction myEventShowControlPolygon(){\r\n\t\tconsole.log(\"ciao\");\r\n\t\tbezierCurve.showControlPolygon();\r\n\t}\r\n\t\r\n\r\n}\r\nnew p5(secondSketch,\"thirdCanvas\");\r\n\r\n\r\n\u003c/script\u003e\r\n\r\n\r\n\r\n\u003cstyle\u003e\r\n\r\ncanvas {\r\n\r\n  border-radius: 30px;\r\n}\r\n\u003c/style\u003e\r\n\r\n\n\u003cbr /\u003e\r\n\u003cbr /\u003e\r\n\u003ch2 id=\"de-casteljau-algorithm\"\u003eDe Casteljau Algorithm\u003c/h2\u003e\n\u003cp\u003eDe Casteljau\u0026rsquo;s algorithm is a stable iterative method for calculating points on a Bézier curve.\nThe algorithm works like this:\n$$\\underline{b}_i^0(t) = \\underline{b}_i$$\n$$\\underline{b}_i^r(t) = (1-t)\\underline{b}_i^{r-1}(t)+t\\underline{b}_k^{r-1}(t)$$\n$$k=i+1;r=1,\u0026hellip;,n; i=0,\u0026hellip;,n-r$$\u003c/p\u003e\n\u003cp\u003eWhere $$\\underline{b}_0^n(t) = \\underline{x}(t)$$ is the point on the Bézier curve associated with the value of the parameter t.\u003c/p\u003e\n\u003ch2 id=\"degree-elevation-algorithm\"\u003eDegree elevation Algorithm\u003c/h2\u003e\n\u003cp\u003eThe degree elevation algorithm transforms a Bézier curve of degree n into a Bézier curve of degree n+1:\u003c/p\u003e\n\u003cp\u003e$$\\underline{x}(t)=\\sum_{i=0}^n \\underline{b}_i B_i^n(t)$$\u003c/p\u003e\n\u003cp\u003e$$= \\sum_{i=0}^{n+1} \\underline{c}_i B_i^{n+1}(t)$$\u003c/p\u003e\n\u003cp\u003ein this way:\u003c/p\u003e\n\u003cp\u003e$$ \\underline{c}_i= \\frac{i}{n+1} \\underline{b}_k + \\frac{n-i+1}{n+1}\\underline{b}_i; k = i-1; i=1,\u0026hellip;,n$$\u003c/p\u003e\n\u003cp\u003e$$\\underline{c}_0=\\underline{b}_0,\\underline{c}_m=\\underline{b}_n; m = n+1$$\u003c/p\u003e\n\u003ch1 id=\"3-dimensional-bézier-curve\"\u003e3-dimensional Bézier curve\u003c/h1\u003e\n\u003cp\u003eIn the editor above, the control points of the bezier curve are control points in 2 dimensions.\nNamely,\n$$\\underline{b}_i = { b_x \\choose b_y}$$\u003c/p\u003e\n\u003cp\u003eHowever, all the algorithms seen above also work for three-dimensional curves, where the control points will also have a z component. All the algorithms therefore remain unchanged,\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eWarning\u003c/strong\u003e: If you are not correctly seeing (or not seeing) the sketch below correctly, visit \u003ca href=\"https://editor.p5js.org/giggiox/full/-UfZh9jUd\"\u003ethis link\u003c/a\u003e. Or \u003ca href=\"https://editor.p5js.org/giggiox/sketches/-UfZh9jUd\"\u003ethis link\u003c/a\u003e to see and edit the source code.\u003c/p\u003e\n\r\n \r\n\u003cdiv id =\"fourthCanvas\" \u003e\u003c/div\u003e\r\n\r\n\u003cdiv class=\"container text-center\"\u003e\r\n\t\u003cdiv class=\"row\"\u003e\r\n\t\t\u003cdiv class=\"col-sm-5 col-md-6\" id =\"sliderCol\"\u003e\r\n\t\tt\r\n\t\t\u003c/div\u003e\r\n\t\t\u003cdiv class=\"col-sm-5 offset-sm-2 col-md-6 offset-md-0\"\u003e\r\n\t\t\tauto play\r\n\t\t\t\u003cbr\u003e\r\n\t\t\t\u003cdiv class=\"checkbox-wrapper-6\" id=\"autoPlay\" style=\"display: inline-block;\"\u003e\r\n\t\t\t  \u003cinput class=\"tgl tgl-light\" id=\"cb1-6-3\" type=\"checkbox\" /\u003e\r\n\t\t\t  \u003clabel class=\"tgl-btn\" for=\"cb1-6-3\"\u003e\r\n\t\t\t\u003c/div\u003e\r\n\t\t\u003c/div\u003e\r\n\t\u003c/div\u003e\r\n\t\u003cdiv class=\"row\"\u003e\r\n\t\t\u003cdiv class=\"col-sm-5 col-md-6\"\u003e\r\n\t\t\tshow construct lines\r\n\t\t\t\u003cbr\u003e\r\n\t\t\t\u003cdiv class=\"checkbox-wrapper-6\" id=\"constructLines2\" style=\"display: inline-block;\"\u003e\r\n\t\t\t  \u003cinput class=\"tgl tgl-light\" id=\"cb1-9\" type=\"checkbox\" checked/\u003e\r\n\t\t\t  \u003clabel class=\"tgl-btn\" for=\"cb1-9\"\u003e\r\n\t\t\t\u003c/div\u003e\t\t\t\r\n\t\t\u003c/div\u003e\r\n\t\t\u003cdiv class=\"col-sm-5 col-md-6\"\u003e\r\n\t\t\tshow control polygon\r\n\t\t\t\u003cbr\u003e\r\n\t\t\t\u003cdiv class=\"checkbox-wrapper-6\" id=\"controlPolygon2\" style=\"display: inline-block;\"\u003e\r\n\t\t\t  \u003cinput class=\"tgl tgl-light\" id=\"cb1-20\" type=\"checkbox\" checked/\u003e\r\n\t\t\t  \u003clabel class=\"tgl-btn\" for=\"cb1-20\"\u003e\r\n\t\t\t\u003c/div\u003e\t\t\t\r\n\t\t\u003c/div\u003e\r\n\t\u003c/div\u003e\r\n\u003c/div\u003e\r\n\r\n\r\n\u003cscript\u003e\r\nvar fourthSketch = function(sketch){\r\n\r\n\tvar bezierCurve;\r\n\tvar slider; var sliderMax = 100;\r\n\tvar checkBoxAutoPlay;  let checkedBoxAutoPlay = false;let addToSlider = 1;\r\n\tvar checkBoxShowConstructLines;\r\n\tvar checkBoxShowControlPolygonLines;\r\n\tvar chhckBoxShowCurveTrace;\r\n\tvar granularity,button,button1;\r\n\tvar canvasResizeFactor = 1.6;\r\n\t\r\n\t\r\n\tlet addedListener = true;\r\n\r\n\r\n\tsketch.setup = function(){\t\t\r\n\t\tbezierCurve = new BezierCurve([[130,130,-20],[-110,80,-100],[20,-90,-20],[20,45,105]]);\r\n\t\t\r\n\t\t\r\n\t\tsketch.frameRate(40); //change this for the slider autoplay velocity\r\n\t\r\n\t\tlet width = document.getElementById(\"forWidth\").offsetWidth;\r\n\t\tvar myCanvas = sketch.createCanvas(width, sketch.windowHeight/1.6,sketch.WEBGL);\r\n\t\t\r\n\t\tcam2 = sketch.createCamera()\r\n\t\t\r\n\t\t\r\n\t\tsketch.colorMode(sketch.HSB);\r\n\t\tsketch.angleMode(sketch.DEGREES);\r\n\t\tsketch.stroke(0,0,0);\r\n\t\tsketch.strokeWeight(4);\r\n\t\t\r\n\t\tslider = sketch.createSlider(0, sliderMax, 1);\r\n\t\tslider.parent(\"sliderCol\");\r\n\t\tslider.addClass(\"myslider\");\r\n\t\tslider.value(sliderMax);\r\n\t\tdocument.getElementById(\"autoPlay\").addEventListener('change',myEventCheckBoxAutoPlay);\r\n\t\t//document.getElementById(\"fourthCanvas\").addEventListener('contextmenu',leftClick);\r\n\t\tdocument.getElementById(\"fourthCanvas\").addEventListener('contextmenu',event =\u003e event.preventDefault()); //remove the window menu for right click\r\n\t\tdocument.getElementById(\"fourthCanvas\").addEventListener('dblclick', doubleClick);\r\n\t\t\r\n\t\tdocument.getElementById(\"constructLines2\").addEventListener('change',myEventShowConstructLines);\r\n\t\tdocument.getElementById(\"controlPolygon2\").addEventListener('change',myEventShowControlPolygon);\r\n\t\t\r\n\t}\r\n\r\n\tsketch.draw = function() {\r\n\t\tsketch.background(250);\r\n\t\t\r\n\t\t// Pan: Cam rotation about y-axis (Left Right)\r\n\t\tlet azimuth = -sketch.atan2(cam2.eyeZ - cam2.centerZ, cam2.eyeX - cam2.centerX);\r\n\t  \r\n\t\t// Tilt: Cam rotation about z-axis (Up Down)\r\n\t\tlet zenith = -sketch.atan2(cam2.eyeY - cam2.centerY, sketch.dist(cam2.eyeX, cam2.eyeZ, cam2.centerX, cam2.centerZ));\r\n\t  \r\n\t\t// f is a scaling factor (depends on canvas size and camera perspective settings)\r\n\t\tlet f = sketch.height * 4.3 / 5;\r\n\t\tlet x = [-1, (sketch.mouseY - sketch.height/2)/f, -(sketch.mouseX - sketch.width/2)/f]\r\n\t  \r\n\t\tlet R = math.multiply(Rz(-zenith), Ry(azimuth))\r\n\t\tx = math.multiply(x, R)\r\n\r\n\t\tlet xMag = sketch.dist(0, 0, 0, x._data[0], x._data[1], x._data[2])\r\n\t\t\r\n\t\tlet objSelected = false;\r\n\t  \r\n\t\tfor(let i = 0; i \u003c bezierCurve.controlPoints.length; i++){\r\n\t\t\tlet dToObj = sketch.dist(cam2.eyeX, cam2.eyeY, cam2.eyeZ, bezierCurve.controlPoints[i].x, bezierCurve.controlPoints[i].y, bezierCurve.controlPoints[i].z);\r\n\t\t\tif(sketch.dist(cam2.eyeX + x._data[0] * dToObj / xMag, cam2.eyeY + x._data[1] * dToObj / xMag, cam2.eyeZ + x._data[2] * dToObj / xMag, bezierCurve.controlPoints[i].x, bezierCurve.controlPoints[i].y, bezierCurve.controlPoints[i].z) \u003c 20) {\r\n\t\t\t\tlet canMove =  true;\r\n\t\t\t\tfor(let j=0;j\u003cbezierCurve.controlPoints.length;j++){\r\n\t\t\t\t\tif(i!=j \u0026\u0026 bezierCurve.controlPoints[j].selected) canMove = false;\r\n\t\t\t\t}\r\n \r\n\t\t\t\tif(sketch.mouseIsPressed  \u0026\u0026 canMove){\r\n\t\t\t\t\tobjSelected = true;\r\n\t\t\t\t\tbezierCurve.controlPoints[i].selected = true;\r\n\t\t\t\t\t\r\n\t\t\t\t\tbezierCurve.controlPoints[i].x = cam2.eyeX + x._data[0] * dToObj / xMag; \r\n\t\t\t\t\tbezierCurve.controlPointsX[i] = bezierCurve.controlPoints[i].x;\r\n\t\t\t\t\tbezierCurve.controlPoints[i].y = cam2.eyeY + x._data[1] * dToObj / xMag; \r\n\t\t\t\t\tbezierCurve.controlPointsY[i] = bezierCurve.controlPoints[i].y;\r\n\t\t\t\t\tbezierCurve.controlPoints[i].z = cam2.eyeZ + x._data[2] * dToObj / xMag;\r\n\t\t\t\t\tbezierCurve.controlPointsZ[i] = bezierCurve.controlPoints[i].z; \r\n\t\t\t\t}else{\r\n\t\t\t\t\tbezierCurve.controlPoints[i].selected = false;\r\n\t\t\t\t\tobjSelected = false;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t\t\r\n\t\t\r\n\t\t\r\n\t\t/**if(!objSelected \u0026\u0026 !addedListener){\r\n\t\t\tconsole.log(\"ciao\");\r\n\t\t\tdocument.getElementById(\"fourthCanvas\").addEventListener('click',sketch.orbitControl(4,4));\r\n\t\t\taddedListener = true;\r\n\t\t}else{\r\n\t\t\tdocument.getElementById(\"fourthCanvas\").removeEventListener('click',sketch.orbitControl(4,4))\r\n\t\t\taddedListener = false;\r\n\t\t}**/\r\n\t\tif(!objSelected){\r\n\t\t\tsketch.orbitControl(4,4);\r\n\t\t}\r\n\t\t\r\n\t\t\r\n\t\tif(checkedBoxAutoPlay){\r\n\t\t\tif(slider.value() == sliderMax) addToSlider = -1;\r\n\t\t\tif(slider.value() == 0 \u0026\u0026 addToSlider \u003c 0 ) addToSlider = 1;\r\n\t\t\tslider.value((slider.value()+addToSlider)); \r\n\t\t}\r\n\t\tbezierCurve.render(); \r\n\t}\r\n\t\r\n\t\r\n\t\r\n\t\r\n\tclass ConstructLine{\r\n\t  \r\n\t  constructor(p1 = null,p2 = null) {\r\n\t\tthis.p1 = p1;\r\n\t\tthis.p2 = p2;\r\n\t\t\r\n\t  }\r\n\t  render() {\r\n\t\t\t//stroke(126);\r\n\t\t\tsketch.strokeWeight(1.5);\r\n\t\t\tsketch.line(this.p1.x,this.p1.y,this.p1.z,this.p2.x,this.p2.y,this.p2.z);\r\n\t  }\r\n\t  \r\n\t}\r\n\t\r\n\r\n\t\r\n\tfunction mapSpace(x,in_min, in_max,out_min,out_max) {\r\n\t\treturn (x - in_min) * (out_max - out_min) / (in_max - in_min) + out_min;\r\n\t}\r\n\r\n\tfunction linspace(startValue, stopValue, cardinality) {\r\n\t\tvar arr = [];\r\n\t\tvar step = (stopValue - startValue) / (cardinality - 1);\r\n\t\tfor (var i = 0; i \u003c cardinality; i++) {\r\n\t\t\tarr.push(startValue + (step * i));\r\n\t\t}\r\n\t\treturn arr;\r\n\t}\r\n\t\r\n\tclass BezierCurve{\r\n\t  constructor(points = []) {\r\n\t\t//TODO add the possibility to create a curve passing arguments\r\n\t\t\r\n\t\t\r\n\t\tthis.controlPoints = [];\r\n\t\tthis.draggedControlPointIndex = -1; // by convention = -1 if we are not dragging any point\r\n\t\t\r\n\t\tthis.controlPointsX = [];\r\n\t\tthis.controlPointsY = [];\r\n\t\tthis.controlPointsZ = [];\r\n\t\t\r\n\t\tthis.granularity = 500;\r\n\t\tthis.t = linspace(0,1,this.granularity);\r\n\t\t\r\n\t\tthis.constructLines = [];\r\n\t\tthis.constructPoints = [];\r\n\t\tthis.controlPolygonLines = [];\r\n\t\t\r\n\t\tthis.checkedShowControlPolygon = true;\r\n\t\tthis.checkedShowConstructLines = true;\r\n\t\tthis.checkedShowCurveTrace = true;\r\n\t\tthis.checkedShowConstructPoints = true;\r\n\t\t\r\n\t\t\r\n\t\tif(points.length != 0){\r\n\t\t\tfor(let i = 0;i\u003cpoints.length; i++){\r\n\t\t\t\tthis.addControlPoint(points[i][0],points[i][1],points[i][2])\r\n\t\t\t}\r\n\t\t}\r\n\t  }\r\n\t  \r\n\t  \r\n\t  addControlPoint(x,y,z){\r\n\t\tthis.controlPoints.push(new ConstructPoint(x,y,z,true));\r\n\t\tthis.controlPointsX.push(x);\r\n\t\tthis.controlPointsY.push(y);\r\n\t\tthis.controlPointsZ.push(z);\r\n\t\t\r\n\t\t\r\n\t\tlet n = this.controlPoints.length;\r\n\t\t\r\n\t\t//number of constructPoint (interpolating points) goes as triangular sequence\r\n\t\t//0,1,3,6,10,15,... = n(n+1)/2\r\n\t\t//for n= 0 (1 control points) -\u003e 0 interpolating points\r\n\t\t//for n= 1 (2 control points)-\u003e 1 interpolating points\r\n\t\t//for n= 2 (3 control points) -\u003e 3 interpolating points\r\n\t\t//for n = 3 (4 control points) -\u003e 6 interpolating points\r\n\t\t//and so on\r\n\t\tfor(let i = 0; i \u003c (n*(n+1)/2 - this.constructPoints.length)-1;i++){\r\n\t\t  this.constructPoints.push(new ConstructPoint(x,y,z));\r\n\t\t}\r\n\t\t\r\n\t\t\r\n\t\t//number of constructLines goes as triangular sequence but with n-1 so (n-1)*(n)/2\r\n\t\t//for n= 0 (1 control points) -\u003e 0 interpolating lines\r\n\t\t//for n= 1 (2 control points)-\u003e 0 interpolating lines\r\n\t\t//for n= 2 (3 control points) -\u003e 1 interpolating lines\r\n\t\t//for n = 3 (4 control points) -\u003e 3 interpolating lines\r\n\t\t//for n = 4 (5 control points) -\u003e 6 interpolating lines\r\n\t\t//and so on\r\n\t\tfor(let i = 0; i\u003c ((n-1)*n/2 - this.constructLines.length)-1; i++){\r\n\t\t  this.constructLines.push(new ConstructLine(this.controlPoints[this.controlPoints.length-2],this.controlPoints[this.controlPoints.length-3]));\r\n\t\t}\r\n\t\t\r\n\t\t\r\n\r\n\t\t//add Control polygon lines\r\n\t\tif(n\u003e1){\r\n\t\t  this.controlPolygonLines.push(new ConstructLine(this.controlPoints[this.controlPoints.length-2],this.controlPoints[this.controlPoints.length-1]));\r\n\t\t}\r\n\t\t\r\n\t\t\r\n\t\t\r\n\t  }\r\n\t  \r\n\t  showConstructPoints(){\r\n\t\tthis.checkedShowConstructPoints = !this.checkedShowConstructPoints;\r\n\t  }\r\n\t  \r\n\t  //change visibility of the control polygon\r\n\t  showControlPolygon(){\r\n\t\tthis.checkedShowControlPolygon = !this.checkedShowControlPolygon;\r\n\t  }\r\n\t  //change visibility of construct lines (interpolating lines)\r\n\t  showConstructLines(){\r\n\t\tthis.checkedShowConstructLines = !this.checkedShowConstructLines;\r\n\t  }\r\n\t  \r\n\t  //change visibility of curve trace\r\n\t  showCurveTrace(){\r\n\t\tthis.checkedShowCurveTrace = ! this.checkedShowCurveTrace;\r\n\t  }\r\n\t  \r\n\t  //calculate de casteljau algorithm\r\n\t  calcBezierPoint(t){\r\n\t\t\r\n\t\tif(this.controlPoints.length == 0){ return null; }\r\n\t\t\r\n\t\t//copy control points coordinate because with them moving, can't make \r\n\t\t//in place replace\r\n\t\tlet controlPointsXCopy = [...this.controlPointsX]; \r\n\t\tlet controlPointsYCopy = [...this.controlPointsY];\r\n\t\tlet controlPointsZCopy = [...this.controlPointsZ];\r\n\t\tlet k = 0; let m = 0;\r\n\t\tfor(let i = 0; i\u003c this.controlPoints.length-1; i++){\r\n\t\t  for(let j = 0; j\u003cthis.controlPoints.length-i-1; j++){\r\n\t\t\tcontrolPointsXCopy[j] = (1-t)*controlPointsXCopy[j] + t*controlPointsXCopy[j+1];        \r\n\t\t\tcontrolPointsYCopy[j] = (1-t)*controlPointsYCopy[j] + t*controlPointsYCopy[j+1];\r\n\t\t\tcontrolPointsZCopy[j] = (1-t)*controlPointsZCopy[j] + t*controlPointsZCopy[j+1];\r\n\t\t\tthis.constructPoints[k].x = controlPointsXCopy[j];\r\n\t\t\tthis.constructPoints[k].y = controlPointsYCopy[j];\r\n\t\t\tthis.constructPoints[k].z = controlPointsZCopy[j];\r\n\t\t\t\r\n\t\t\tif(j\u003e0){\r\n\t\t\t  this.constructLines[m].p1 = this.constructPoints[k];\r\n\t\t\t  this.constructLines[m].p2 = this.constructPoints[k-1];\r\n\t\t\t  m+=1;\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\tk += 1;\r\n\t\t  }\r\n\t\t}\r\n\t\treturn [controlPointsXCopy[0], controlPointsYCopy[0],controlPointsZCopy[0]]\r\n\t\t\r\n\t  }\r\n\t  \r\n\t  mousePressedAction(){\r\n\t\tfor (let i = 0; i \u003c this.controlPoints.length; i++) {\r\n\t\t  let vertexUI = this.controlPoints[i];\r\n\t\t  \r\n\t\t  if(vertexUI.hasInside(sketch.mouseX,sketch.mouseY)){\r\n\t\t\tthis.draggedControlPointIndex = i;\r\n\t\t  }\r\n\t\t}\r\n\t\t\r\n\t  }\r\n\t  \r\n\t  mouseDraggedAction(){\r\n\t\tif (this.draggedControlPointIndex == -1)\r\n\t\t\t\treturn;\r\n\t\tlet newMouseX = sketch.mouseX;\r\n\t\tlet newMouseY = sketch.mouseY;\r\n\t\t\r\n\t\tthis.controlPoints[this.draggedControlPointIndex].x = newMouseX;\r\n\t\tthis.controlPoints[this.draggedControlPointIndex].y = newMouseY;\r\n\t\tthis.controlPointsX[this.draggedControlPointIndex] = newMouseX;\r\n\t\tthis.controlPointsY[this.draggedControlPointIndex] = newMouseY;\r\n\t\t\r\n\t  }\r\n\t   mouseReleasedAction() {\r\n\t\t\tthis.draggedControlPointIndex = -1;\r\n\t\t}\r\n\t  \r\n\t  \r\n\t  render(){\r\n\t\tfor(let i = 0; i \u003c this.controlPoints.length; i++){\r\n\t\t  this.controlPoints[i].render();\r\n\t\t}\r\n\t\t\r\n\t\t\r\n\t\t//commented because this draws the whole curve without accounting the slider\r\n\t\t/*for(let i = 0; i\u003c this.t.length; i++){\r\n\t\t  let tmp = this.calcBezierPoint(this.t[i]);\r\n\t\t  if(tmp != null){\r\n\t\t\t//console.log(tmp[0] + \"  \" + tmp[1]);\r\n\t\t\tstroke(0);\r\n\t\t\tstrokeWeight(2);\r\n\t\t\tellipse(tmp[0],tmp[1], 1, 1);\r\n\t\t  }\r\n\t\t}*/\r\n\t\t\r\n\t\t//the slider.value() != 0 removes imperfections in visualization. (overlapping lines or points not returning to the begininning)\r\n\t\tif(this.checkedShowConstructPoints \u0026\u0026 slider.value() != 0 \u0026\u0026 slider.value() != sliderMax){\r\n\t\t  for(let i = 0; i\u003c this.constructPoints.length; i++){\r\n\t\t\tthis.constructPoints[i].render();\r\n\t\t  }\r\n\t\t}\r\n\t\t\r\n\t\tif(this.checkedShowConstructLines \u0026\u0026 slider.value() != 0 \u0026\u0026 slider.value() != sliderMax){\r\n\t\t  for(let i = 0; i\u003c this.constructLines.length; i++){\r\n\t\t\tthis.constructLines[i].render();\r\n\t\t  }\r\n\t\t}\r\n\t\t\r\n\t\tif(this.checkedShowControlPolygon){\r\n\t\t  for(let i = 0; i\u003c this.controlPolygonLines.length; i++){\r\n\t\t\tthis.controlPolygonLines[i].render();\r\n\t\t  }\r\n\t\t}\r\n\t  \r\n\t\tsketch.stroke(\"blue\");\r\n\t\tsketch.beginShape(sketch.POINTS);\r\n\t\tfor(let i = 0; i\u003c mapSpace(slider.value(),0,100,0,this.granularity); i++){\r\n\t\t\t\r\n\t\t  let tmp = this.calcBezierPoint(this.t[i]);\r\n\t\t  if(tmp != null \u0026\u0026  this.checkedShowCurveTrace){\r\n\t\t\tsketch.strokeWeight(1);\r\n\t\t\t\r\n\t\t\t//se vuoi che la curva sia per esempio blu devi togliere quel scketch.POINTS, ma poi diventa tutto molto,molto più lento.\r\n\t\t\tsketch.vertex(tmp[0],tmp[1],tmp[2]);\r\n\t\t\t\r\n\t\t  }\r\n\t\t}\r\n\t\tsketch.endShape();\r\n\t\tsketch.stroke(0)\r\n\t\t\r\n\t  }\r\n\t}\r\n\t\r\n\t\r\n\t\r\n\tclass ConstructPoint{\r\n\t\tconstructor(x = null, y = null,  z = null, isControlPoint = false, radius = 3) {\r\n\t\t\tthis.x = x;\r\n\t\t\tthis.y = y;\r\n\t\t\tthis.z = z;\r\n\t\t\tthis.radius = radius;\r\n\t\t\tthis.selected = false; //used for moving points around\r\n\t\t\tthis.isControlPoint = isControlPoint;\r\n\t\t}\r\n\t\trender() {\r\n\t\t\tif(this.isControlPoint){\r\n\t\t\t\tsketch.push(); // enter local coordinate system\r\n\t\t\t\tsketch.translate(this.x, this.y, this.z);\r\n\t\t\t\tsketch.sphere(this.radius);\r\n\t\t\t\tsketch.pop(); // exit local coordinate system (back to global coordinates)\r\n\t\t\t}else{\r\n\t\t\t\tsketch.strokeWeight(5);\r\n\t\t\t\tsketch.beginShape(sketch.POINTS);\r\n\t\t\t\tsketch.vertex(this.x,this.y,this.z);\r\n\t\t\t\tsketch.endShape();\r\n\t\t\t}\r\n\t\t}  \r\n\t\t\r\n\t\t/**\r\n\t\thasInside only used for a point that is a bezier control point. We need to know if the mouse is inside in order to move it.\r\n\t\t\r\n\t\t**/\r\n\t\thasInside(x, y) {\r\n\t\t\tlet distance = sketch.dist(this.x, this.y, x, y);\r\n\t\t\treturn distance \u003c= this.grabbableRadius; \r\n\t\t\t\r\n\t\t}\r\n\t}\r\n\t\r\n\t\r\n\tsketch.mousePressed = function(){\r\n\t  bezierCurve.mousePressedAction();\r\n\t}\r\n\r\n\tsketch.mouseDragged = function(){\r\n\t  bezierCurve.mouseDraggedAction();\r\n\t}\r\n\r\n\tsketch.mouseReleased = function(){\r\n\t  bezierCurve.mouseReleasedAction()\r\n\t}\r\n\t\r\n\tsketch.windowResized = function(){ \r\n\t\tlet width = document.getElementById(\"forWidth\").offsetWidth;\r\n\t\tsketch.resizeCanvas(width,sketch.widowHeight/1.6);\r\n\t}\r\n\t\r\n\tfunction myEventCheckBoxAutoPlay(){\r\n\t  checkedBoxAutoPlay = !checkedBoxAutoPlay;\r\n\t}\r\n\t\r\n\tfunction myEventShowConstructLines(){\r\n\t\tbezierCurve.showConstructLines();\r\n\t\tbezierCurve.showConstructPoints()\r\n\t}\r\n\t\r\n\tfunction myEventShowControlPolygon(){\r\n\t\tconsole.log(\"ciao\");\r\n\t\tbezierCurve.showControlPolygon();\r\n\t}\r\n\r\n\tfunction doubleClick(){\r\n\t\tbezierCurve.addControlPoint(0,0,0);\r\n\t}\r\n\t\r\n\t// Rotation matrix for rotation about x-axis\r\n\tfunction Rx(th) {\r\n\t\treturn math.matrix([[1, 0, 0],\r\n                 [0, sketch.cos(th), -sketch.sin(th)],\r\n                 [0, sketch.sin(th), sketch.cos(th)]\r\n                ]);\r\n\t}\r\n\r\n\t// Rotation matrix for rotation about y-axis\r\n\tfunction Ry(th) {\r\n\t\treturn math.matrix([[sketch.cos(th), 0, -sketch.sin(th)],\r\n                 [0, 1, 0],\r\n                 [sketch.sin(th), 0, sketch.cos(th)]\r\n                ])\r\n\t}\r\n  \r\n\t// Rotation matrix for rotation about z-axis\r\n\tfunction Rz(th) {\r\n\t\treturn math.matrix([[sketch.cos(th), sketch.sin(th), 0],\r\n                [-sketch.sin(th), sketch.cos(th), 0],\r\n                [0, 0, 1]])\r\n\t}\r\n\r\n}\r\nnew p5(fourthSketch,\"fourthCanvas\");\r\n\r\n\r\n\u003c/script\u003e\r\n\r\n\r\n\n\u003ch1 id=\"patch-di-bézier\"\u003ePatch di Bézier\u003c/h1\u003e\n\u003cp\u003eA Bézier patch is defined as\u003c/p\u003e\n\u003cp\u003e$$ \\underline{X}(u,v) = \\sum_{i=0}^n \\sum_{j=0}^m \\underline{c}_{ij} B_i^n(u)B_j^m(v), (u,v)\\in[0,1]^2$$\u003c/p\u003e\n\u003cp\u003eThe skatch below shows a bicubic Bézier patch, i.e. with m=n=3.\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eWarning\u003c/strong\u003e: If you are not correctly seeing (or not seeing) the sketch below correctly, visit \u003ca href=\"https://editor.p5js.org/giggiox/full/ePuLYaR4t\"\u003ethis link\u003c/a\u003e. Or \u003ca href=\"https://editor.p5js.org/giggiox/sketches/ePuLYaR4t\"\u003ethis link\u003c/a\u003e to see and edit the source code.\n\r\n\r\n\r\n\u003cdiv id =\"sixthCanvas\" \u003e\u003c/div\u003e\r\n\u003cdiv class=\"container text-center\"\u003e\r\n\t\u003cdiv class=\"row\"\u003e\r\n\t\t\u003cdiv class=\"col-sm-5 col-md-6\"\u003e\r\n\t\t\tshow control points\r\n\t\t\t\u003cbr\u003e\r\n\t\t\t\u003cdiv class=\"checkbox-wrapper-6\" id=\"controlPoints3\" style=\"display: inline-block;\"\u003e\r\n\t\t\t  \u003cinput class=\"tgl tgl-light\" id=\"cb1-25\" type=\"checkbox\" checked/\u003e\r\n\t\t\t  \u003clabel class=\"tgl-btn\" for=\"cb1-25\"\u003e\r\n\t\t\t\u003c/div\u003e\t\t\t\r\n\t\t\u003c/div\u003e\r\n\t\t\u003cdiv class=\"col-sm-5 col-md-6\"\u003e\r\n\t\t\tshow control net\r\n\t\t\t\u003cbr\u003e\r\n\t\t\t\u003cdiv class=\"checkbox-wrapper-6\" id=\"controlNet3\" style=\"display: inline-block;\"\u003e\r\n\t\t\t  \u003cinput class=\"tgl tgl-light\" id=\"cb1-22\" type=\"checkbox\" checked/\u003e\r\n\t\t\t  \u003clabel class=\"tgl-btn\" for=\"cb1-22\"\u003e\r\n\t\t\t\u003c/div\u003e\t\t\t\r\n\t\t\u003c/div\u003e\r\n\t\u003c/div\u003e\r\n\u003c/div\u003e\r\n\r\n\u003cscript\u003e\r\nvar sixthSketch = function(sketch){\r\n\r\n\tvar bezierSurface;\r\n\r\n\r\n\tsketch.setup = function(){\r\n\t\tlet ctrl_pts = [\r\n\t\t\t[[0, 0, 20],  [60, 0, -35],   [90, 0, 60],    [200, 0, 5]],\r\n\t\t\t[[0, 50, 30], [100, 60, -25], [120, 50, 120], [200, 50, 5]],\r\n\t\t\t[[0, 100, 0], [60, 120, 35],  [90, 100, 60],  [200, 100, 45]],\r\n\t\t\t[[0, 150, 0], [60, 150, -35], [90, 180, 60],  [200, 150, 45]]\r\n\t\t];\r\n\t\tbezierSurface = new BezierSurface(ctrl_pts);\r\n\t\tsketch.frameRate(40); //change this for the slider autoplay velocity\r\n\t\tlet width = document.getElementById(\"forWidth\").offsetWidth;\r\n\t\tvar myCanvas = sketch.createCanvas(width, sketch.windowHeight/1.6,sketch.WEBGL);\r\n\t\t\r\n\t\tcam1 = sketch.createCamera();\r\n\t\tcam1.lookAt(100,60,0);\r\n\t\t/* check for double click since p5js does not offer a Canvas.mouseDoubleClick but only a canvas.mouseClick. Using the function doubleClicked of p5js does not work because it's global and with more than 1 canvas on a page it gets mad */\r\n\t\t\r\n\t\t//document.getElementById(\"fifthCanvas\").addEventListener('dblclick', doubleClick);\r\n\t\t\r\n\t\tsketch.colorMode(sketch.HSB);\r\n\t\tsketch.angleMode(sketch.DEGREES);\r\n\t\t\r\n\t\t\r\n\t\t//document.getElementById(\"sixthCanvas\").addEventListener('contextmenu',leftClick);\r\n\t\tdocument.getElementById(\"sixthCanvas\").addEventListener('contextmenu',event =\u003e event.preventDefault()); //remove the window menu for right click\r\n\t\t\r\n\t\tdocument.getElementById(\"controlPoints3\").addEventListener('change',myEventShowControlPoints);\r\n\t\tdocument.getElementById(\"controlNet3\").addEventListener('change',myEventShowControlNet);\r\n\t\t\r\n\t}\r\n\r\n\tsketch.draw = function() {\r\n\t\tsketch.background(250);\r\n\t\t\r\n\t\t// Pan: Cam rotation about y-axis (Left Right)\r\n\t\tlet azimuth = -sketch.atan2(cam1.eyeZ - cam1.centerZ, cam1.eyeX - cam1.centerX);\r\n\t  \r\n\t\t// Tilt: Cam rotation about z-axis (Up Down)\r\n\t\tlet zenith = -sketch.atan2(cam1.eyeY - cam1.centerY, sketch.dist(cam1.eyeX, cam1.eyeZ, cam1.centerX, cam1.centerZ));\r\n\t  \r\n\t\t// f is a scaling factor (depends on canvas size and camera perspective settings)\r\n\t\tlet f = sketch.height * 4.3 / 5;\r\n\t\tlet x = [-1, (sketch.mouseY - sketch.height/2)/f, -(sketch.mouseX - sketch.width/2)/f]\r\n\t  \r\n\t\tlet R = math.multiply(Rz(-zenith), Ry(azimuth))\r\n\t\tx = math.multiply(x, R)\r\n\r\n\t\tlet xMag = sketch.dist(0, 0, 0, x._data[0], x._data[1], x._data[2])\r\n\t\t\r\n\t\tlet objSelected = false;\r\n\t\t\r\n\t\t\r\n\t\tfor(let i = 0; i \u003c bezierSurface.controlPoints.length; i++){\r\n\t\t\tlet dToObj = sketch.dist(cam1.eyeX, cam1.eyeY, cam1.eyeZ, bezierSurface.controlPoints[i].x, bezierSurface.controlPoints[i].y, bezierSurface.controlPoints[i].z);\r\n\t\t\tif(sketch.dist(cam1.eyeX + x._data[0] * dToObj / xMag, \r\n\t\t\t\tcam1.eyeY + x._data[1] * dToObj / xMag, \r\n\t\t\t\tcam1.eyeZ + x._data[2] * dToObj / xMag, \r\n\t\t\t\tbezierSurface.controlPoints[i].x, bezierSurface.controlPoints[i].y, bezierSurface.controlPoints[i].z) \u003c 20) {\r\n\t\t\t\tlet canMove =  true;\r\n\t\t\t\tfor(let j=0;j\u003cbezierSurface.controlPoints.length;j++){\r\n\t\t\t\t\tif(i!=j \u0026\u0026 bezierSurface.controlPoints[j].selected) canMove = false;\r\n\t\t\t\t}\r\n\t\t\t\t\r\n\t\t\t\tif(sketch.mouseIsPressed \u0026\u0026 canMove){\r\n\t\t\t\t\tobjSelected = true;\r\n\t\t\t\t\tbezierSurface.controlPoints[i].selected = true;\r\n\t\t\t\t\t\r\n\t\t\t\t\tbezierSurface.controlPoints[i].x =cam1.eyeX + (x._data[0] * dToObj) / xMag;\r\n\t\t\t\t\tbezierSurface.controlPoints[i].y =cam1.eyeY + (x._data[1] * dToObj) / xMag;\r\n\t\t\t\t\tbezierSurface.controlPoints[i].z =cam1.eyeZ + (x._data[2] * dToObj) / xMag;\r\n\t\t\t\t\r\n\t\t\t\t\tlet idx = math.floor(i/4);\r\n\t\t\t\t   \r\n\t\t\t\t\tbezierSurface.bezierCurvesV[idx].controlPoints[i%4].x =bezierSurface.controlPoints[i].x;\r\n\t\t\t\t\tbezierSurface.bezierCurvesV[idx].controlPointsX[i%4] =bezierSurface.controlPoints[i].x;\r\n\t\t\t\t\tbezierSurface.bezierCurvesV[idx].controlPoints[i%4].y =bezierSurface.controlPoints[i].y;\r\n\t\t\t\t\tbezierSurface.bezierCurvesV[idx].controlPointsY[i%4] =bezierSurface.controlPoints[i].y;\r\n\t\t\t\t\tbezierSurface.bezierCurvesV[idx].controlPoints[i%4].z =bezierSurface.controlPoints[i].z;\r\n\t\t\t\t\tbezierSurface.bezierCurvesV[idx].controlPointsZ[i%4] =bezierSurface.controlPoints[i].z;\r\n\t\t\t\t}else{\r\n\t\t\t\t\tbezierSurface.controlPoints[i].selected = false;\r\n\t\t\t\t\tobjSelected = false;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t\t\r\n\t\t\r\n\t\t\r\n\t\t\r\n\t\tif (!objSelected) {\r\n\t\t\tsketch.orbitControl(1,1);\r\n\t\t}\r\n\t\tbezierSurface.render();\r\n\t}\r\n\t\r\n\t\r\n\t\r\n\r\n\tfunction linspace(startValue, stopValue, cardinality) {\r\n\t\tvar arr = [];\r\n\t\tvar step = (stopValue - startValue) / (cardinality - 1);\r\n\t\tfor (var i = 0; i \u003c cardinality; i++) {\r\n\t\t\tarr.push(startValue + (step * i));\r\n\t\t}\r\n\t\treturn arr;\r\n\t}\r\n\t\r\n\tclass ConstructPoint{\r\n\t\tconstructor(x = null, y = null, z = null, isControlPoint = false) {\r\n\t\t\tthis.x = x\r\n\t\t\tthis.y = y\r\n\t\t\tthis.z = z;\r\n\t\t\tthis.selected = false; //used for moving point around\r\n\t\t\tthis.isControlPoint = isControlPoint;\r\n\t\t}\r\n\t\trender() {\r\n\t\t\tif(this.isControlPoint){\r\n\t\t\t\tsketch.push();\r\n\t\t\t\tsketch.translate(this.x,this.y,this.z);\r\n\t\t\t\tsketch.sphere(2)\r\n\t\t\t\tsketch.pop();\r\n\t\t\t}else{\r\n\t\t\t\tsketch.strokeWeight(5);\r\n\t\t\t\tsketch.beginShape(POINTS);\r\n\t\t\t\tsketch.vertex(this.x,this.y,this.z);\r\n\t\t\t\tsketch.endShape();\r\n\t\t\t}\r\n        }\r\n\t}\r\n\t\r\n\tclass BezierSurface{\r\n\t\tconstructor(points = []){\r\n\t\t\tthis.showNet = true;\r\n\t\t\tthis.showingNetPoints = true;\r\n\t\t\tthis.controlPoints = [];\r\n\t\t\tthis.u = 10;\r\n\t\t\tthis.v = 10;\r\n\t\t\tthis.bezierCurvesV = [];\r\n\t\t\tthis.bezierCurvesU = [];\r\n\t\t\t\r\n\t\t\tif(points.length != 0){\r\n\t\t\t\tfor(let i = 0;i\u003cpoints.length; i++){\r\n\t\t\t\t\tfor(let j = 0;j\u003cpoints[0].length;j++){\r\n\t\t\t\t\t\tthis.addControlPoint(points[i][j][0],points[i][j][1],points[i][j][2],true);\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\tfor(let i=0;i\u003cpoints.length;i++){\r\n\t\t\t\t\tlet bz = new BezierCurve(points[i]);\r\n\t\t\t\t\tbz.showCurve = false;\r\n\t\t\t\t\tbz.changeGranularity(this.v);\r\n\t\t\t\t\tthis.bezierCurvesV.push(bz);\r\n\t\t\t\t}\r\n\t\t\t\tfor(let j=0;j\u003cthis.v;j++){\r\n\t\t\t\t\tlet bz = new BezierCurve();\r\n\t\t\t\t\tbz.changeGranularity(this.u);\r\n\t\t\t\t\tthis.bezierCurvesU.push(bz);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t\tshowNetPoints(){\r\n\t\t\tthis.showingNetPoints = !this.showingNetPoints;\r\n\t\t}\r\n\t\t\r\n\t\tshowNetEvent(){\r\n\t\t\tthis.showNet = !this.showNet;\r\n\t\t}\r\n  \r\n\t\taddControlPoint(x,y,z,isControlPoint = false){\r\n\t\t\tthis.controlPoints.push(new ConstructPoint(x,y,z,isControlPoint));\r\n\t\t}\r\n \r\n\t\trender(){\r\n\t\t\tfor(let i = 0; i \u003c this.controlPoints.length; i++){\r\n\t\t\t\tif(this.showingNetPoints){\r\n\t\t\t\t\tthis.controlPoints[i].render();\r\n\t\t\t\t}\r\n\t\t\t\tsketch.strokeWeight(1)\r\n\t\t\t\tlet coloumnsNumber = this.bezierCurvesV.length;\r\n\t\t\t\tif(i%coloumnsNumber != 0 \u0026\u0026 this.showNet){ \r\n\t\t\t\t\tsketch.line(this.controlPoints[i].x,this.controlPoints[i].y,this.controlPoints[i].z,this.controlPoints[i-1].x,this.controlPoints[i-1].y,this.controlPoints[i-1].z)\r\n\t\t\t\t}\r\n\t\t\t\tif(i\u003e=coloumnsNumber \u0026\u0026 this.showNet){\r\n\t\t\t\t\tsketch.line(this.controlPoints[i].x,this.controlPoints[i].y,this.controlPoints[i].z,this.controlPoints[i-coloumnsNumber].x,this.controlPoints[i-coloumnsNumber].y,this.controlPoints[i-coloumnsNumber].z)\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\tfor(let i=0;i\u003cthis.bezierCurvesV.length;i++){\r\n\t\t\t\tthis.bezierCurvesV[i].render();\r\n\t\t\t}\r\n    \r\n    \r\n\t\t\tfor(let j=0;j\u003cthis.v;j++){\r\n\t\t\t\tlet cpoints = [];\r\n\t\t\t\tfor (let k = 0; k \u003c this.bezierCurvesV[0].controlPoints.length; k++) {\r\n\t\t\t\t\tcpoints.push([this.bezierCurvesV[k].points[j][0],this.bezierCurvesV[k].points[j][1],this.bezierCurvesV[k].points[j][2]]);\r\n\t\t\t\t}\r\n\t\t\t\tthis.bezierCurvesU[j] = new BezierCurve(cpoints)\r\n\t\t\t\tthis.bezierCurvesU[j].changeGranularity(this.u);\r\n\t\t\t\tthis.bezierCurvesU[j].showCurve = false;\r\n\t\t\t\tthis.bezierCurvesU[j].render();\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\tfor(let j=0;j\u003cthis.v-1;j++){\r\n\t\t\t\tfor(let i=0;i\u003cthis.bezierCurvesU[j].points.length-1;i++){\r\n\t\t\t\t\tsketch.beginShape(sketch.QUAD_STRIP);\r\n\t\t\t\t\tsketch.vertex(this.bezierCurvesU[j].points[i][0],this.bezierCurvesU[j].points[i][1],this.bezierCurvesU[j].points[i][2]);\r\n\t\t\t\t\tsketch.vertex(this.bezierCurvesU[j+1].points[i][0],this.bezierCurvesU[j+1].points[i][1],this.bezierCurvesU[j+1].points[i][2]);\r\n\t\t\t\t\tsketch.vertex(this.bezierCurvesU[j].points[i+1][0],this.bezierCurvesU[j].points[i+1][1],this.bezierCurvesU[j].points[i+1][2]);\r\n\t\t\t\t\tsketch.vertex(this.bezierCurvesU[j+1].points[i+1][0],this.bezierCurvesU[j+1].points[i+1][1],this.bezierCurvesU[j+1].points[i+1][2])\r\n\t\t\t\t\tsketch.endShape();\r\n\t\t\t\t}\t\t\t\t\r\n\t\t\t}\r\n\t\t}\r\n  \r\n\t}\r\n\t\r\n\tclass BezierCurve{\r\n\t\tconstructor(points = []) {\r\n\t\t\tthis.showCurve = true;\r\n\t\t\tthis.rendered = false;\r\n\t\t\tthis.controlPoints = [];\r\n\t\t\tthis.draggedControlPointIndex = -1; // by convention = -1 if we are not dragging any point\r\n\t\t\t\r\n\t\t\tthis.controlPointsX = [];\r\n\t\t\tthis.controlPointsY = [];\r\n\t\t\tthis.controlPointsZ = [];\r\n\t\t\t\r\n\t\t\tthis.granularity = 1000;\r\n\t\t\tthis.t = linspace(0,1,this.granularity);\r\n\t\t\t\r\n\t\t\tthis.points = Array(this.granularity).fill(0);\r\n\t\t\t\r\n\t\t\tthis.constructLines = [];\r\n\t\t\tthis.constructPoints = [];\r\n\t\t\tthis.controlPolygonLines = [];\r\n\t\t\t\r\n\t\t\tthis.checkedShowControlPolygon = true;\r\n\t\t\tthis.checkedShowConstructLines = true;\r\n\t\t\tthis.checkedShowCurveTrace = true;\r\n\t\t\t\r\n\t\t\tif(points.length != 0){\r\n\t\t\t  for(let i = 0;i\u003cpoints.length; i++){\r\n\t\t\t\tthis.addControlPoint(points[i][0],points[i][1],points[i][2]);\r\n\t\t\t  }\r\n\t\t\t}\r\n\t\t}\r\n   \r\n  \r\n\t\tchangeGranularity(x){\r\n\t\t\tthis.granularity = x;\r\n\t\t\tthis.t = linspace(0,1,x);\r\n\t\t\tthis.points = Array(x).fill(0);\r\n\t\t}\r\n  \r\n\t\taddControlPoint(x,y,z){\r\n\t\t\tthis.controlPoints.push(new ConstructPoint(x,y,z));\r\n\t\t\tthis.controlPointsX.push(x);\r\n\t\t\tthis.controlPointsY.push(y);\r\n\t\t\tthis.controlPointsZ.push(z);\r\n\t\t}\r\n  \r\n\t\t//calculate de casteljau algorithm\r\n\t\tcalcBezierPoint(t){\r\n    \r\n\t\t\tif(this.controlPoints.length == 0){ return null; }\r\n    \r\n\t\t\t//copy control points coordinate because with them moving, can't make \r\n\t\t\t//in place replace\r\n\t\t\tlet controlPointsXCopy = [...this.controlPointsX]; \r\n\t\t\tlet controlPointsYCopy = [...this.controlPointsY];\r\n\t\t\tlet controlPointsZCopy = [...this.controlPointsZ];\r\n\t\t\tlet k = 0; let m = 0;\r\n\t\t\tfor(let i = 0; i\u003c this.controlPoints.length-1; i++){\r\n\t\t\t\tfor(let j = 0; j\u003cthis.controlPoints.length-i-1; j++){\r\n\t\t\t\t\tcontrolPointsXCopy[j] = (1-t)*controlPointsXCopy[j] + t*controlPointsXCopy[j+1];      \r\n\t\t\t\t\tcontrolPointsYCopy[j] = (1-t)*controlPointsYCopy[j] + t*controlPointsYCopy[j+1];\r\n\t\t\t\t\tcontrolPointsZCopy[j] = (1-t)*controlPointsZCopy[j] + t*controlPointsZCopy[j+1];\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\treturn [controlPointsXCopy[0], controlPointsYCopy[0], controlPointsZCopy[0]]\r\n    \r\n\t\t}\r\n  \r\n  \r\n\t\trender(){\t\r\n\t\t\tif (this.showCurve) {\r\n\t\t\t\tsketch.beginShape(sketch.POINTS);\r\n\t\t\t\tsketch.strokeWeight(2);\r\n\t\t\t\tsketch.stroke(\"blue\");\r\n\t\t\t\tfor (let i = 0; i \u003c this.t.length; i++) {\r\n\t\t\t\t\tlet tmp = this.calcBezierPoint(this.t[i]);\r\n\t\t\t\t\tif (tmp != null) {\r\n\t\t\t\t\t\tsketch.vertex(tmp[0], tmp[1], tmp[2]);\r\n\t\t\t\t\t\tthis.points[i] = [tmp[0], tmp[1], tmp[2]];\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\tsketch.stroke(0)\r\n\t\t\t\tsketch.endShape();\r\n\t\t\t}else{\r\n\t\t\t\tfor (let i = 0; i \u003c this.t.length; i++) {\r\n\t\t\t\t\tlet tmp = this.calcBezierPoint(this.t[i]);\r\n\t\t\t\t\tif (tmp != null) {\r\n\t\t\t\t\t\tthis.points[i] = [tmp[0], tmp[1], tmp[2]];\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\tsketch.windowResized = function(){ \r\n\t\tlet width = document.getElementById(\"forWidth\").offsetWidth;\r\n\t\tsketch.resizeCanvas(width,sketch.widowHeight/1.6);\r\n\t}\r\n\t\r\n\t\r\n\tfunction myEventShowControlPoints(){\r\n\t\tbezierSurface.showNetPoints();\r\n\t}\r\n\tfunction myEventShowControlNet(){\r\n\t\tbezierSurface.showNetEvent();\r\n\t}\r\n\t\r\n\t\r\n\t// Rotation matrix for rotation about x-axis\r\n\tfunction Rx(th) {\r\n\t\treturn math.matrix([[1, 0, 0],\r\n                 [0, sketch.cos(th), -sketch.sin(th)],\r\n                 [0, sketch.sin(th), sketch.cos(th)]]);\r\n\t}\r\n\r\n\t// Rotation matrix for rotation about y-axis\r\n\tfunction Ry(th) {\r\n\t\treturn math.matrix([[sketch.cos(th), 0, -sketch.sin(th)],\r\n                 [0, 1, 0],\r\n                 [sketch.sin(th), 0, sketch.cos(th)]]);\r\n\t}\r\n  \r\n\t// Rotation matrix for rotation about z-axis\r\n\tfunction Rz(th) {\r\n\t\treturn math.matrix([[sketch.cos(th), sketch.sin(th), 0],\r\n                [-sketch.sin(th), sketch.cos(th), 0],\r\n                [0, 0, 1]]);\r\n\t}\r\n\t\r\n\t\r\n\r\n}\r\n\r\n\r\n\r\n\r\n\r\n\r\nnew p5(sixthSketch,\"sixthCanvas\");\r\n\r\n\r\n\u003c/script\u003e\r\n\u003c/p\u003e\n\r\n \r\n\r\n\r\n\u003cstyle\u003e\r\n\r\n  .checkbox-wrapper-6 .tgl {\r\n    display: none;\r\n  }\r\n  .checkbox-wrapper-6 .tgl,\r\n  .checkbox-wrapper-6 .tgl:after,\r\n  .checkbox-wrapper-6 .tgl:before,\r\n  .checkbox-wrapper-6 .tgl *,\r\n  .checkbox-wrapper-6 .tgl *:after,\r\n  .checkbox-wrapper-6 .tgl *:before,\r\n  .checkbox-wrapper-6 .tgl + .tgl-btn {\r\n    box-sizing: border-box;\r\n  }\r\n  .checkbox-wrapper-6 .tgl::-moz-selection,\r\n  .checkbox-wrapper-6 .tgl:after::-moz-selection,\r\n  .checkbox-wrapper-6 .tgl:before::-moz-selection,\r\n  .checkbox-wrapper-6 .tgl *::-moz-selection,\r\n  .checkbox-wrapper-6 .tgl *:after::-moz-selection,\r\n  .checkbox-wrapper-6 .tgl *:before::-moz-selection,\r\n  .checkbox-wrapper-6 .tgl + .tgl-btn::-moz-selection,\r\n  .checkbox-wrapper-6 .tgl::selection,\r\n  .checkbox-wrapper-6 .tgl:after::selection,\r\n  .checkbox-wrapper-6 .tgl:before::selection,\r\n  .checkbox-wrapper-6 .tgl *::selection,\r\n  .checkbox-wrapper-6 .tgl *:after::selection,\r\n  .checkbox-wrapper-6 .tgl *:before::selection,\r\n  .checkbox-wrapper-6 .tgl + .tgl-btn::selection {\r\n    background: none;\r\n  }\r\n  .checkbox-wrapper-6 .tgl + .tgl-btn {\r\n    outline: 0;\r\n    display: block;\r\n    width: 4em;\r\n    height: 2em;\r\n    position: relative;\r\n    cursor: pointer;\r\n    -webkit-user-select: none;\r\n       -moz-user-select: none;\r\n        -ms-user-select: none;\r\n            user-select: none;\r\n  }\r\n  .checkbox-wrapper-6 .tgl + .tgl-btn:after,\r\n  .checkbox-wrapper-6 .tgl + .tgl-btn:before {\r\n    position: relative;\r\n    display: block;\r\n    content: \"\";\r\n    width: 50%;\r\n    height: 100%;\r\n  }\r\n  .checkbox-wrapper-6 .tgl + .tgl-btn:after {\r\n    left: 0;\r\n  }\r\n  .checkbox-wrapper-6 .tgl + .tgl-btn:before {\r\n    display: none;\r\n  }\r\n  .checkbox-wrapper-6 .tgl:checked + .tgl-btn:after {\r\n    left: 50%;\r\n  }\r\n\r\n  .checkbox-wrapper-6 .tgl-light + .tgl-btn {\r\n    background: #f0f0f0;\r\n    border-radius: 2em;\r\n    padding: 2px;\r\n    transition: all 0.4s ease;\r\n  }\r\n  .checkbox-wrapper-6 .tgl-light + .tgl-btn:after {\r\n    border-radius: 50%;\r\n    background: #fff;\r\n    transition: all 0.2s ease;\r\n  }\r\n  .checkbox-wrapper-6 .tgl-light:checked + .tgl-btn {\r\n    background: #0000fe;\r\n  }\r\n  \r\n\r\ncanvas {\r\n\r\n  border-radius: 30px;\r\n}\r\n\r\n\r\n.myslider {\r\n  -webkit-appearance: none;\r\n  width: 100%;\r\n  height: 15px;\r\n  border-radius: 5px;  \r\n  background: #d3d3d3;\r\n  outline: none;\r\n  opacity: 0.7;\r\n  -webkit-transition: .2s;\r\n  transition: opacity .2s;\r\n}\r\n\r\n.myslider::-webkit-slider-thumb {\r\n  -webkit-appearance: none;\r\n  appearance: none;\r\n  width: 25px;\r\n  height: 25px;\r\n  border-radius: 50%; \r\n  background: #0000fe;\r\n  cursor: pointer;\r\n}\r\n\r\n.myslider::-moz-range-thumb {\r\n  width: 25px;\r\n  height: 25px;\r\n  border-radius: 50%;\r\n  background: #0000fe;\r\n  cursor: pointer;\r\n}\r\n\r\n.button {\r\n  background-color: #0000fe;\r\n  border: none;\r\n  color: white;\r\n  padding: 20px;\r\n  text-align: center;\r\n  text-decoration: none;\r\n  display: inline-block;\r\n  font-size: 16px;\r\n  margin: 4px 2px;\r\n  cursor: pointer;\r\n}\r\n.button2 {border-radius: 8px;}\r\n\r\n\u003c/style\u003e\r\n\r\n\n\u003ch1 id=\"p5js-implementation-notes\"\u003ep5js Implementation Notes\u003c/h1\u003e\n\u003cp\u003eThe code is written with the \u003ca href=\"https://p5js.org/es/\"\u003ep5js\u003c/a\u003e library and was written using OOP methodology.\nIn general, all 2d-3d versions and also Bézier patches consist of the following classes and methods:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-js\" data-lang=\"js\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#66d9ef\"\u003eclass\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eBezierCurve\u003c/span\u003e{\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\t\u003cspan style=\"color:#66d9ef\"\u003efunction\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003econstructor\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003epoints\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e:\u003c/span\u003e Array[Array[\u003cspan style=\"color:#66d9ef\"\u003efloat\u003c/span\u003e]]){}\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\t\u003cspan style=\"color:#66d9ef\"\u003efunction\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eaddControlPoint\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003ex\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e:\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003efloat\u003c/span\u003e, \u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e:\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003efloat\u003c/span\u003e){}\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\t\u003cspan style=\"color:#66d9ef\"\u003efunction\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003edeCastelJau\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003et\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e:\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003efloat\u003c/span\u003e){}\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\t\u003cspan style=\"color:#66d9ef\"\u003efunction\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003erender\u003c/span\u003e(){\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\t\t\u003cspan style=\"color:#75715e\"\u003e//ConstructPoints.render() for all ConstructPoints\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e\u003c/span\u003e\t\t\u003cspan style=\"color:#75715e\"\u003e//ConstructLines.render() for all ConstructLines\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e\u003c/span\u003e\t}\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e}\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#66d9ef\"\u003eclass\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eConstructPoint\u003c/span\u003e{\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\t\u003cspan style=\"color:#66d9ef\"\u003efunction\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003econstructor\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003ex\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e:\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003efloat\u003c/span\u003e, \u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e:\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003efloat\u003c/span\u003e) {}\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\t\u003cspan style=\"color:#66d9ef\"\u003efunction\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003erender\u003c/span\u003e() {}  \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\t\u003cspan style=\"color:#66d9ef\"\u003efunction\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ehasInside\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003ex\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e:\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003efloat\u003c/span\u003e, \u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e:\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003efloat\u003c/span\u003e) {}\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e}\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#66d9ef\"\u003eclass\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eConstructLine\u003c/span\u003e{  \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\t\u003cspan style=\"color:#66d9ef\"\u003efunction\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003econstructor\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003ep1\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e:\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eConstructPoint\u003c/span\u003e,\u003cspan style=\"color:#a6e22e\"\u003ep2\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e:\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eConstructPoint\u003c/span\u003e) {}\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\t\u003cspan style=\"color:#66d9ef\"\u003efunction\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003erender\u003c/span\u003e(){}\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e}\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eSo to create a Bézier curve you need to instantiate a \u003ccode\u003evar bezierCurve = BezierCurve(points)\u003c/code\u003e, then on the p5js \u003ccode\u003edraw()\u003c/code\u003e method call the curve\u0026rsquo;s render method like this: \u003ccode\u003ebezierCurve.render()\u003c/code\u003e.\u003c/p\u003e\n\u003cp\u003eFor the Bézier patches, however, an additional class has been created which instantiates multiple BezierCurve classes.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-js\" data-lang=\"js\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#66d9ef\"\u003eclass\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eBezierPatch\u003c/span\u003e{\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\t\u003cspan style=\"color:#66d9ef\"\u003efunction\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003econstructor\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003epoints\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e:\u003c/span\u003e Array[Array[\u003cspan style=\"color:#66d9ef\"\u003efloat\u003c/span\u003e]]){}\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\t\u003cspan style=\"color:#66d9ef\"\u003efunction\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eaddControlPoint\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003ex\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e:\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003efloat\u003c/span\u003e, \u003cspan style=\"color:#a6e22e\"\u003ey\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e:\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003efloat\u003c/span\u003e){}\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\t\u003cspan style=\"color:#66d9ef\"\u003efunction\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003erender\u003c/span\u003e(){}\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e}\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e","description":"","image":"/projects/bezier/copertina9.png","permalink":"/en/projects/bezier/","title":"Bézier curves and patches - interactive visualization"},{"content":"\u003ch1 id=\"introduction\"\u003eIntroduction\u003c/h1\u003e\n\u003cp\u003eThe aim of this project is to develop a cheaper alternative to the telemetry systems available on the market for mountain bikes.\u003c/p\u003e\n\u003cp\u003eTelemetry systems for mountain bikes monitor and acquire data on the position of the bike\u0026rsquo;s fork and shock absorber while riding. This data is crucial for off-road sports enthusiasts and professional athletes, as it provides valuable information for analysing and improving performance.\u003c/p\u003e\n\u003cp\u003eCurrently, many telemetry systems, such as \u003ca href=\"https://www.bybtech.it/\"\u003ebyb telemetry\u003c/a\u003e, use expensive linear potentiometers to accurately measure the position of the fork and shock absorber.\u003c/p\u003e\n\u003cp\u003eOther users on the internet have tried other ways to get a good result, for example a \u003ca href=\"https://www.vitalmtb.com/forums/The-Hub,2/DIY-mtb-telemetry-data,11126\"\u003eLiDar sensor\u003c/a\u003e, but the results were not too encouraging as they were too noisy.\u003c/p\u003e\n\u003cp\u003eTherefore, after careful evaluation, I have concluded that using a rotary encoder is a more cost-effective alternative.\u003c/p\u003e\n\u003cp\u003eThe main reason for this choice is that rotary encoders are less expensive than linear potentiometers and still offer good position measurement accuracy. In addition, rotary encoders are generally more robust and less prone to damage than linear encoders, which can be more fragile and susceptible to failure in off-road environments.\u003c/p\u003e\n\u003ch3 id=\"how-a-rotative-encoder-works\"\u003ehow a rotative encoder works\u003c/h3\u003e\n\u003cp\u003eEncoders can sense movement in either direction, detecting holes or marks as they move through 2 positions. When the blue disc in the diagram below rotates clockwise, changes are first detected by pin 1 and then pin 2. When it rotates counterclockwise, pin 2 is the first to detect changes. This scheme is called \u0026lsquo;quadrature coding\u0026rsquo; because the waveforms detected by the 2 pins are offset by 90 degrees.\u003c/p\u003e\n\r\n \r\n\u003ccenter\u003e\r\n\u003ctable class=\"d-flex justify-content-center\"\u003e\r\n\t\u003ctr\u003e\r\n\t\t\u003ctd style=\"background: none !important; border: none !important\"\u003e\r\n\t\t\t\u003cimg src=\"/projects/forktelemetry/td_libs_Encoder_pos1.png\" id=\"quad\"\u003e\r\n\t\t\u003c/td\u003e\r\n\t\u003c/tr\u003e\r\n\t\u003ctr\u003e\r\n\t\t\u003ctd align=\"center\" style=\"background: none !important; border: none !important\"\u003e\r\n\t\t\t\u003cform action=\"#\"\u003e\r\n\t\t\t\t\u003cinput type=\"submit\" value=\"\u003c- counterclockwise\" onClick=\"rotate(-1); return false\"\u003e\r\n\t\t\t\t\u003cinput type=\"text\" value=\"0\" id=\"accum\" size=6\u003e\r\n\t\t\t\t\u003cinput type=\"submit\" value=\"clockwise -\u003e\" onClick=\"rotate(1); return false\"\u003e\r\n\t\t\t\u003c/form\u003e\r\n\t\t\u003c/td\u003e\r\n\t\u003c/tr\u003e\r\n\u003c/table\u003e\r\n\u003c/center\u003e\r\n\u003cscript\u003e\r\nvar img = new Array();\r\nimg[0] = new Image();\r\nimg[1] = new Image();\r\nimg[2] = new Image();\r\nimg[3] = new Image();\r\nimg[0].src = \"/projects/forktelemetry/td_libs_Encoder_pos1.png\";\r\nimg[1].src = \"/projects/forktelemetry/td_libs_Encoder_pos2.png\";\r\nimg[2].src = \"/projects/forktelemetry/td_libs_Encoder_pos3.png\";\r\nimg[3].src = \"/projects/forktelemetry/td_libs_Encoder_pos4.png\";\r\nvar position = 0;\r\nfunction rotate(n) {\r\nval = Number(document.getElementById('accum').value) + n;\r\nif (isNaN(val)) val = 0;\r\ndocument.getElementById('accum').value = val;\r\nposition += n;\r\nif (position \u003e 3) position = 0;\r\nif (position \u003c 0) position = 3;\r\ndocument.getElementById('quad').src = img[position].src;\r\n}\r\n\u003c/script\u003e\r\n\n\u003cp\u003e(animation taken from \u003ca href=\"https://www.pjrc.com/teensy/td_libs_Encoder.html\"\u003equesto sito\u003c/a\u003e)\u003c/p\u003e\n\u003ch1 id=\"pre---prototyping\"\u003epre - prototyping\u003c/h1\u003e\n\u003cp\u003eBefore proceeding with the prototyping of the fork sensor, I carried out a feasibility analysis to assess the feasibility of this project.\u003c/p\u003e\n\u003cp\u003eAs a starting point, I selected a reliable rotary encoder: the LPD3806. This type of encoder offers a resolution of 600 PPR (pulses per revolution). Using a pulley with a diameter of 9.4 mm, a density of approximately 30 detections per millimetre of fork movement is achieved. This is because the encoder generates a quadrature signal that can be read on both the rising and falling edges. By exploiting both edges, we obtain a quadrupled resolution of the encoder, i.e. 24000 PPR (600 PPR * 4).\u003c/p\u003e\n\u003cp\u003eCalculating the number of possible observations per millimetre of fork movement, we obtain the following result:\u003c/p\u003e\n\u003cp\u003e$$ \\frac{600 * 4}{\\pi* 9.4} \\approx 30 $$\u003c/p\u003e\n\u003cp\u003eFor example, considering a 150 mm travel fork, there will be approximately 12190 detections (this value will be used in the code).\u003c/p\u003e\n\u003cp\u003eIt is important to note that increasing the diameter of the pulley coupled to the encoder reduces the density of detections per millimetre of movement. Furthermore, the maximum response speed of the encoder must be taken into account, which determines the maximum linear speed that the fork can reach. In the case of the LPD3806, the maximum speed is:\u003c/p\u003e\n\u003cp\u003e​$$ 2000 RPM = 2000/60 RPS = $$\n$$ 2000* (\\pi*9.4) /60 \\frac{mm}{s} \\approx 983 \\frac{mm}{s} $$\u003c/p\u003e\n\u003cp\u003eUsing a pulley with a smaller diameter will result in a lower maximum detectable linear speed.\u003c/p\u003e\n\u003cp\u003eWith this initial information, I therefore started the prototyping process.\u003c/p\u003e\n\u003ch1 id=\"prototyping\"\u003eprototyping\u003c/h1\u003e\n\u003cp\u003eFor the prototyping of the fork sensor, I used the \u003ca href=\"https://www.autodesk.it/products/fusion-360/overview\"\u003efusion 360\u003c/a\u003e software. After several iterations, I arrived at the following result:\u003c/p\u003e\n\r\n \r\n\u003ccenter\u003e\r\n\u003cimg src=\"/projects/forktelemetry/forkSensor.jpg\"  width=\"80%\" \u003e\r\n\u003c/center\u003e\r\n\n\r\n \r\n\u003cscript type=\"module\" src=\"/model-viewer.min.js\"\u003e\u003c/script\u003e\r\n\u003ccenter\u003e\r\n\u003cmodel-viewer style=\"width: 80; height: 80vh\" src=\"/projects/forktelemetry/forksensor3d.glb\" ar ar-modes=\"webxr scene-viewer quick-look\" camera-controls poster=\"/projects/forktelemetry/forkSensor3dPoster.webp\" shadow-intensity=\"1\" autoplay camera-orbit=\"-38.89deg 61.4deg 644.1m\" field-of-view=\"30deg\"\u003e\r\n    \u003cdiv class=\"progress-bar hide\" slot=\"progress-bar\"\u003e\r\n        \u003cdiv class=\"update-bar\"\u003e\u003c/div\u003e\r\n    \u003c/div\u003e\r\n\u003c/model-viewer\u003e\r\n\u003c/center\u003e\r\n\n\u003cp\u003eThe fusion360 file is available on GitHub at \u003ca href=\"https://github.com/giggiox/fork-telemetry/tree/main/fusio360files/v1\"\u003ethis link\u003c/a\u003e.\nUsing \u003ca href=\"https://www.blender.org/\"\u003eblender\u003c/a\u003e we can also show a concept of how it works once mounted on a fork.\u003c/p\u003e\n\r\n \r\n\u003ccenter\u003e\r\n\u003cmodel-viewer style=\"width: 80; height: 80vh\" src=\"/projects/forktelemetry/forksensorAnimation.glb\" ar ar-modes=\"webxr scene-viewer quick-look\" camera-controls poster=\"/projects/forktelemetry/forkSensorAnimationPoster.webp\" shadow-intensity=\"1\" autoplay camera-orbit=\"-216.6deg 65.99deg 1356m\" field-of-view=\"30deg\"\u003e\r\n    \u003cdiv class=\"progress-bar hide\" slot=\"progress-bar\"\u003e\r\n        \u003cdiv class=\"update-bar\"\u003e\u003c/div\u003e\r\n    \u003c/div\u003e\r\n\u003c/model-viewer\u003e\r\n\u003c/center\u003e\r\n\n\u003cp\u003eFor the design, I was inspired by the movement of the axes of a 3D printer and integrated a belt tensioning mechanism, typical of this type of printer.\u003c/p\u003e\n\u003cp\u003eSubsequently, I used the Arduino Nano to create a working Proof of Concept (POC). Overall, the system consists of 2 switches, 1 SD module, 1 Arduino Nano, 1 9-volt battery and the LPD3806 encoder.\nWhere:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003ea switch is used to turn the system on\u003c/li\u003e\n\u003cli\u003eThe other switch enables the writing of the encoder position with the chosen encoding ([encoder_position,]) to the SD card. This switch must be activated before the start of the descent and switched off immediately afterwards.\u003c/li\u003e\n\u003c/ul\u003e\n\r\n \r\n\u003ccenter\u003e\r\n\u003cimg src=\"/projects/forktelemetry/forktelemetry-schematics.png\"  width=\"60%\" \u003e\r\n\u003c/center\u003e\r\n\n\u003cp\u003eAt this point, I also designed a capture box using Fusion 360.\n\r\n \r\n\u003ccenter\u003e\r\n\u003cimg src=\"/projects/forktelemetry/openbox_fusion.PNG\"  width=\"80%\" \u003e\r\n\u003c/center\u003e\r\n\nThe box, which is designed so that it can be fixed with 2 clamps to the top tube of the bike, contains all components (except the encoder) and makes the 2 switches accessible from the outside.\n\r\n \r\n\u003ccenter\u003e\r\n\u003cimg src=\"/projects/forktelemetry/box_fusion.PNG\"  width=\"80%\" \u003e\r\n\u003c/center\u003e\r\n\u003c/p\u003e\n\u003ch1 id=\"stampa-e-codice\"\u003estampa e codice\u003c/h1\u003e\n\u003cp\u003eOnce printed (and assembled) the sensor and acquisition box by soldering the components on a millefori\u003c/p\u003e\n\r\n \r\n\u003ccenter\u003e\r\n\u003cimg src=\"/projects/forktelemetry/collage.png\"  width=\"80%\" \u003e\r\n\u003c/center\u003e\r\n\n\u003cp\u003ethe whole thing looks like this:\u003c/p\u003e\n\r\n \r\n\u003ccenter\u003e\r\n\u003cimg src=\"/projects/forktelemetry/laydown.jpg\"  width=\"80%\" \u003e\r\n\u003c/center\u003e\r\n\n\u003cp\u003eOperation once mounted on the MTB is as follows:\u003c/p\u003e\n\r\n \r\n\u003ccenter\u003e\r\n\u003cvideo width=35% controls\u003e\r\n    \u003csource src=\"/projects/forktelemetry/video.mp4\" type=\"video/mp4\" \u003e\r\n    Your browser does not support the video tag.  \r\n\u003c/video\u003e\r\n\u003c/center\u003e\r\n\n\u003cp\u003eThe code instead is as follows.\nNote that the port manipulation technique was used to obtain a maximum speed in reading the encoder.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-cpp\" data-lang=\"cpp\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e#include\u003c/span\u003e \u003cspan style=\"color:#75715e\"\u003e\u0026lt;SPI.h\u0026gt;\u003c/span\u003e\u003cspan style=\"color:#75715e\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e#include\u003c/span\u003e \u003cspan style=\"color:#75715e\"\u003e\u0026lt;SD.h\u0026gt;\u003c/span\u003e\u003cspan style=\"color:#75715e\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e#include\u003c/span\u003e \u003cspan style=\"color:#75715e\"\u003e\u0026lt;String.h\u0026gt;\u003c/span\u003e\u003cspan style=\"color:#75715e\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e#define encoderPinA 3\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e#define encoderPinB 2\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e#define buttonPin 7\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e#define SD_PIN 10\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003eFile logFile;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#66d9ef\"\u003ebool\u003c/span\u003e enableWriteToSD\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003efalse;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e newDirectoryName\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e\u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#66d9ef\"\u003eint\u003c/span\u003e newFileName\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e\u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#66d9ef\"\u003ebool\u003c/span\u003e startRecord;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#66d9ef\"\u003evolatile\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003elong\u003c/span\u003e encoderPosition\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e\u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#66d9ef\"\u003evolatile\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003ebool\u003c/span\u003e aStatePrev,bStatePrev,aState,bState;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#66d9ef\"\u003evoid\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003esetup\u003c/span\u003e() {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  Serial.begin(\u003cspan style=\"color:#ae81ff\"\u003e9600\u003c/span\u003e);\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  \u003cspan style=\"color:#75715e\"\u003e//setup rotary encoder\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e\u003c/span\u003e  DDRD \u003cspan style=\"color:#f92672\"\u003e\u0026amp;=\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e((\u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e\u0026lt;\u0026lt;\u003c/span\u003e encoderPinA) \u003cspan style=\"color:#f92672\"\u003e|\u003c/span\u003e (\u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e\u0026lt;\u0026lt;\u003c/span\u003e encoderPinB));\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  \u003cspan style=\"color:#75715e\"\u003e// Abilita i pull-up interni\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e\u003c/span\u003e  PORTD \u003cspan style=\"color:#f92672\"\u003e|=\u003c/span\u003e (\u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e\u0026lt;\u0026lt;\u003c/span\u003e encoderPinA) \u003cspan style=\"color:#f92672\"\u003e|\u003c/span\u003e (\u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e\u0026lt;\u0026lt;\u003c/span\u003e encoderPinB);\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  attachInterrupt(digitalPinToInterrupt(encoderPinA),handleEncoderInterrupt,CHANGE);\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  attachInterrupt(digitalPinToInterrupt(encoderPinB),handleEncoderInterrupt,CHANGE);\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  \u003cspan style=\"color:#75715e\"\u003e//setup SD\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e\u003c/span\u003e  \u003cspan style=\"color:#66d9ef\"\u003eif\u003c/span\u003e(\u003cspan style=\"color:#f92672\"\u003e!\u003c/span\u003eSD.begin(SD_PIN)){ \u003cspan style=\"color:#66d9ef\"\u003ewhile\u003c/span\u003e(true); }\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  \u003cspan style=\"color:#66d9ef\"\u003ewhile\u003c/span\u003e(SD.exists(String(newDirectoryName))){ newDirectoryName\u003cspan style=\"color:#f92672\"\u003e++\u003c/span\u003e; }\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  \u003cspan style=\"color:#66d9ef\"\u003eif\u003c/span\u003e (SD.mkdir(String(newDirectoryName))){\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    Serial.print(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Created new directory: \u0026#34;\u003c/span\u003e);\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    Serial.println(newDirectoryName);\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  }\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  \u003cspan style=\"color:#75715e\"\u003e//setup record button\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e\u003c/span\u003e  DDRD \u003cspan style=\"color:#f92672\"\u003e\u0026amp;=\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e\u0026lt;\u0026lt;\u003c/span\u003e buttonPin);\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  PORTD \u003cspan style=\"color:#f92672\"\u003e|=\u003c/span\u003e (\u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e\u0026lt;\u0026lt;\u003c/span\u003e buttonPin);\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  Serial.println(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;setup completed\u0026#34;\u003c/span\u003e);\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e}\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#66d9ef\"\u003evoid\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eloop\u003c/span\u003e() {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  startRecord\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003ePIND\u003cspan style=\"color:#f92672\"\u003e\u0026amp;\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e\u0026lt;\u0026lt;\u003c/span\u003ebuttonPin);\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  \u003cspan style=\"color:#66d9ef\"\u003eif\u003c/span\u003e(startRecord \u003cspan style=\"color:#f92672\"\u003e\u0026amp;\u0026amp;\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e!\u003c/span\u003eenableWriteToSD){\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    logFile \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e SD.open(String(newDirectoryName) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;/\u0026#34;\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e  String(newFileName\u003cspan style=\"color:#f92672\"\u003e++\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;.txt\u0026#34;\u003c/span\u003e, FILE_WRITE);\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eif\u003c/span\u003e (logFile) { Serial.println(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Writing to \u0026#34;\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e String(newFileName\u003cspan style=\"color:#f92672\"\u003e-\u003c/span\u003e\u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e)); }\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    enableWriteToSD\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003etrue;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  }\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  \u003cspan style=\"color:#66d9ef\"\u003eelse\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003eif\u003c/span\u003e(startRecord \u003cspan style=\"color:#f92672\"\u003e\u0026amp;\u0026amp;\u003c/span\u003e enableWriteToSD) {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e     logFile.print(String(encoderPosition)\u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;,\u0026#34;\u003c/span\u003e);\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  }\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  \u003cspan style=\"color:#66d9ef\"\u003eelse\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003eif\u003c/span\u003e(\u003cspan style=\"color:#f92672\"\u003e!\u003c/span\u003estartRecord \u003cspan style=\"color:#f92672\"\u003e\u0026amp;\u0026amp;\u003c/span\u003e enableWriteToSD){\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    enableWriteToSD\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003efalse;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    logFile.close();\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  }\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e}\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#66d9ef\"\u003evoid\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ehandleEncoderInterrupt\u003c/span\u003e(){\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  \u003cspan style=\"color:#75715e\"\u003e// Leggi lo stato corrente dei segnali A e B\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e\u003c/span\u003e  aState \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e PIND \u003cspan style=\"color:#f92672\"\u003e\u0026amp;\u003c/span\u003e (\u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e\u0026lt;\u0026lt;\u003c/span\u003e encoderPinA);\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  bState \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e PIND \u003cspan style=\"color:#f92672\"\u003e\u0026amp;\u003c/span\u003e (\u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e\u0026lt;\u0026lt;\u003c/span\u003e encoderPinB);\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  \u003cspan style=\"color:#75715e\"\u003e// Verifica se il fronte di salita è avvenuto sul segnale A\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e\u003c/span\u003e  \u003cspan style=\"color:#66d9ef\"\u003eif\u003c/span\u003e (aState \u003cspan style=\"color:#f92672\"\u003e!=\u003c/span\u003e aStatePrev) {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    aStatePrev \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e aState;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#75715e\"\u003e// Verifica il cambiamento di direzione dell\u0026#39;encoder\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e\u003c/span\u003e    \u003cspan style=\"color:#66d9ef\"\u003eif\u003c/span\u003e (aStatePrev \u003cspan style=\"color:#f92672\"\u003e==\u003c/span\u003e bStatePrev) {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      encoderPosition\u003cspan style=\"color:#f92672\"\u003e--\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    } \u003cspan style=\"color:#66d9ef\"\u003eelse\u003c/span\u003e {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      encoderPosition\u003cspan style=\"color:#f92672\"\u003e++\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    }\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  }\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  \u003cspan style=\"color:#75715e\"\u003e// Memorizza lo stato corrente dei segnali A e B per il prossimo interrupt\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e\u003c/span\u003e  bStatePrev \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e bState;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e}\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch1 id=\"first-tests-and-results\"\u003efirst tests and results\u003c/h1\u003e\n\u003cp\u003eWhen the switch is activated, the code starts recording the encoder position and saves it in a log file in its folder. The log file contains the encoder position values separated by commas.\u003c/p\u003e\n\u003cp\u003eI have created a website in javascript that uses the \u003ca href=\"https://plotly.com/javascript/\"\u003ePlotly JS\u003c/a\u003e library to display this data (\u003ca href=\"https://github.com/giggiox/fork-telemetry/tree/main/web\"\u003eGitHub link to site code\u003c/a\u003e). For example, the video I showed earlier produces a log file that can be opened in the site and generates this output:\u003c/p\u003e\n\r\n \r\n\u003ccenter\u003e\r\n\u003cimg src=\"/projects/forktelemetry/plot.png\"  width=\"80%\" \u003e\r\n\u003c/center\u003e\r\n\n\u003cp\u003eThe scatter plot shows the sampling number on the abscissas and the fork compression in millimetres on the ordinates.\u003c/p\u003e\n\u003cp\u003eBelow the graph there are also tabular data indicating the number of bottom-outs recorded (none here), the most frequent value of fork compression and the percentage of fork used (here over 26 mm on a 150 mm fork, i.e. around 18%).\u003c/p\u003e\n\u003ch3 id=\"telemetry-display-on-screen\"\u003etelemetry display on screen\u003c/h3\u003e\n\u003cp\u003eI have also created a python script (\u003ca href=\"https://github.com/giggiox/fork-telemetry/blob/main/videoEdit.ipynb\"\u003eGitHub link to script\u003c/a\u003e) which is based on \u003ca href=\"https://pypi.org/project/Pillow/\"\u003ePillow\u003c/a\u003e and \u003ca href=\"https://pypi.org/project/opencv-python/\"\u003ecv2\u003c/a\u003e.\nThis script allows you to insert the telemetry detected on a video, which for the video I showed earlier, produces an effect similar to this:\u003c/p\u003e\n\r\n \r\n\u003ccenter\u003e\r\n\u003cvideo width=35% controls\u003e\r\n    \u003csource src=\"/projects/forktelemetry/videoTelemetry.mp4\" type=\"video/mp4\" \u003e\r\n    Your browser does not support the video tag.  \r\n\u003c/video\u003e\r\n\u003c/center\u003e\r\n\n\u003cp\u003eThis script first creates 101 images of the rectangle with the percentage written inside (0% to 100%). It then puts these images together in a video where each image represents a value measured by the sensor.\u003c/p\u003e\n\u003ch1 id=\"field-tests\"\u003efield tests\u003c/h1\u003e\n\u003cp\u003eWhen I tested the system on a real enduro descent, I encountered the first difficulties and restrictions of the hardware I used (especially the arduino). In fact, if the shocks are too fast, the pulse count coming from the encoder starts to \u0026lsquo;drift\u0026rsquo; and become increasingly negative.\u003c/p\u003e\n\r\n \r\n\u003ccenter\u003e\r\n\u003cimg src=\"/projects/forktelemetry/testSulCampo.PNG\"  width=\"80%\" \u003e\r\n\u003c/center\u003e\r\n\n\u003cp\u003eThis is because the encoder frequency ranges from 0 to 20KHz.\nThis implies that there is at least a 50 microsecond interval between one rising edge and another.\nAssuming that only the rising edges of signal A are read (thus lowering the accuracy estimate made earlier by a quarter), the arduino still cannot do all the necessary operations in this short time.\nIn fact it should\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003edo a \u003ccode\u003edigitalRead()\u003c/code\u003e on the signal pin B\u003c/li\u003e\n\u003cli\u003ewrite the position on the SD\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eIn the next 2 I try to examine the code and explain why the arduino is not the correct hardware to proceed.\u003c/p\u003e\n\u003ch2 id=\"digitalread\"\u003edigitalRead\u003c/h2\u003e\n\u003cp\u003eFor example let\u0026rsquo;s look at how long a digitalRead() takes using port manipulation.\nWe can for example take this arduino code that does a digitalRead() of encoderPinB and if it is HIGH then it adds 1 to encoderPosition, otherwise it decreases the variable by 1.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-cpp\" data-lang=\"cpp\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#66d9ef\"\u003evoid\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ehandleEncoderInterrupt\u003c/span\u003e(){\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  \u003cspan style=\"color:#75715e\"\u003e// Leggi lo stato corrente del segnale B\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e\u003c/span\u003e  PIND \u003cspan style=\"color:#f92672\"\u003e\u0026amp;\u003c/span\u003e (\u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e\u0026lt;\u0026lt;\u003c/span\u003e encoderPinB) \u003cspan style=\"color:#f92672\"\u003e?\u003c/span\u003e encoderPosition \u003cspan style=\"color:#f92672\"\u003e+=\u003c/span\u003e\u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e:\u003c/span\u003e encoderPosition \u003cspan style=\"color:#f92672\"\u003e-=\u003c/span\u003e\u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e}\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eand decompile it \u003ccode\u003eC:\\Users\\luigi\\AppData\\Local\\Temp\\arduino_build_211859\u0026gt;\u0026quot;C:\\Program Files (x86)\\Arduino\\hardware\\tools\\avr\\bin\\avr-objdump.exe\u0026quot; -S codice_test.ino.elf\u003c/code\u003e\u003c/p\u003e\n\u003cp\u003eottenendo\u003c/p\u003e\n\u003cpre tabindex=\"0\"\u003e\u003ccode class=\"language-assembly\" data-lang=\"assembly\"\u003ea8:   4a 9b           sbis    0x09, 2 ; 9\r\naa:   0c c0           rjmp    .+24            ; 0xc4 \u0026lt;_Z22handleEncoderInterruptv+0x1c\u0026gt;\r\nac:   80 91 04 01     lds     r24, 0x0104     ; 0x800104 \u0026lt;__data_end\u0026gt;\r\nb0:   90 91 05 01     lds     r25, 0x0105     ; 0x800105 \u0026lt;__data_end+0x1\u0026gt;\r\nb4:   a0 91 06 01x     lds     r26, 0x0106     ; 0x800106 \u0026lt;__data_end+0x2\u0026gt;\r\nb8:   b0 91 07 01     lds     r27, 0x0107     ; 0x800107 \u0026lt;__data_end+0x3\u0026gt;\r\nbc:   01 96           adiw    r24, 0x01       ; 1\r\nbe:   a1 1d           adc     r26, r1\r\nc0:   b1 1d           adc     r27, r1\r\nc2:   0b c0           rjmp    .+22            ; 0xda \u0026lt;_Z22handleEncoderInterruptv+0x32\u0026gt;\r\nc4:   80 91 04 01     lds     r24, 0x0104     ; 0x800104 \u0026lt;__data_end\u0026gt;\r\nc8:   90 91 05 01     lds     r25, 0x0105     ; 0x800105 \u0026lt;__data_end+0x1\u0026gt;\r\ncc:   a0 91 06 01     lds     r26, 0x0106     ; 0x800106 \u0026lt;__data_end+0x2\u0026gt;\r\nd0:   b0 91 07 01     lds     r27, 0x0107     ; 0x800107 \u0026lt;__data_end+0x3\u0026gt;\r\nd4:   01 97           sbiw    r24, 0x01       ; 1\r\nd6:   a1 09           sbc     r26, r1\r\nd8:   b1 09           sbc     r27, r1\r\nda:   80 93 04 01     sts     0x0104, r24     ; 0x800104 \u0026lt;__data_end\u0026gt;\r\nde:   90 93 05 01     sts     0x0105, r25     ; 0x800105 \u0026lt;__data_end+0x1\u0026gt;\r\ne2:   a0 93 06 01     sts     0x0106, r26     ; 0x800106 \u0026lt;__data_end+0x2\u0026gt;\r\ne6:   b0 93 07 01     sts     0x0107, r27     ; 0x800107 \u0026lt;__data_end+0x3\u0026gt;\r\nea:   08 95           ret\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003eIn particular, the instructions that do the digital readout of encoderPinB are the 2nd to 6th, i.e. the 4 instructions that use \u003ccode\u003elds\u003c/code\u003e (Load direct from SRAM).\nFrom the \u003ca href=\"https://ww1.microchip.com/downloads/en/DeviceDoc/Atmel-7810-Automotive-Microcontrollers-ATmega328P_Datasheet.pdf\"\u003eATmega328 datasheet (page 283)\u003c/a\u003e we can see that these instructions take exactly 2 clock cycles.\u003c/p\u003e\n\r\n \r\n\u003ccenter\u003e\r\n\u003cimg src=\"/projects/forktelemetry/datasheet.PNG\"  width=\"80%\" \u003e\r\n\u003c/center\u003e\r\n\n\u003cp\u003eSo being a 16Mhz microcontroller (1 clock cycle takes 1/16,000,000th of a second, or 62.5 nanoseconds), then those 4 instructions take 8 cycles * 62.5 ns/cycle = 500 ns.\u003c/p\u003e\n\u003cp\u003eFrom this analysis, it can be deduced that digitalRead() is not the bottleneck in the code.\u003c/p\u003e\n\u003ch2 id=\"write-to-sd\"\u003ewrite to SD\u003c/h2\u003e\n\u003cp\u003eInstead, let\u0026rsquo;s look at how long a write to the SD takes. To get a more or less approximate number, we can for example print out the number of milliseconds before and after the position is written to memory.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-cpp\" data-lang=\"cpp\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003eSerial.println(millis());\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003elogFile.print(String(encoderPosition)\u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;,\u0026#34;\u003c/span\u003e);\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003eSerial.println(millis());\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eAnd we can see that indeed the bottleneck is in this call, which can take up to 200 milliseconds. Of course, this time also depends on the SD used.\u003c/p\u003e\n\u003ch1 id=\"future-developments\"\u003efuture developments\u003c/h1\u003e\n\u003cul\u003e\n\u003cli\u003euse a microcontroller with several cores, e.g. an esp32 where one core takes care of reading the encoder signal and another takes care of sampling (which can then be done constantly e.g. 1000 times per second) and writing the encoder position to the SD.\u003c/li\u003e\n\u003cli\u003euse a Bluetooth module to communicate data to an android application, also in real time.\u003c/li\u003e\n\u003cli\u003eadd a GPS module so that you can have in the analysis panel not only the position of the fork metre by metre but also the position of the rider along the descent.\u003c/li\u003e\n\u003cli\u003esensor redesign. The first design I did was top-down (also because it was the first time I had used fusion360 and also the first time I had really created something functional) and with box shapes (not structurally strong) and a lot can be improved. For example, using a linear guide can reduce the complexity of the sensor (and also the weight) but also the degrees of freedom of the system. Below is a possible v2 design using a 6mm linear guide.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\r\n \r\n\u003ccenter\u003e\r\n\u003cimg src=\"/projects/forktelemetry/rev2.PNG\"  width=\"80%\" \u003e\r\n\u003c/center\u003e\r\n\nThe fusion360 file for this version is available on GitHub at \u003ca href=\"https://github.com/giggiox/fork-telemetry/tree/main/fusio360files/v2\"\u003ethis link\u003c/a\u003e .\u003c/p\u003e\n","description":"","image":"/projects/forktelemetry/renders/render.png","permalink":"/en/projects/fork-telemetry/","title":"fork telemetry"},{"content":"\u003ch1 id=\"graphtheory-visualizer\"\u003egraphTheory-Visualizer\u003c/h1\u003e\n\u003cp\u003eThe project was done to visualize the operations that can be done on a graph, such as BFS, DFS, Kruskal, and Dijkstra.\u003c/p\u003e\n\u003cp\u003eThe goal is to have a real time update of the various operations, so that if the graph changes while an \u0026lsquo;operation is being performed on it, the result of the operation also changes.\u003c/p\u003e\n\u003cp\u003eThe project is active on GitHub pages and a demo can be accessed from this link: \u003cmark\u003e\u003ca href=\"https://giggiox.github.io/graphTheory-Visualizer/\"\u003ehttps://giggiox.github.io/graphTheory-Visualizer/\u003c/a\u003e\u003c/mark\u003e \u003cbr/\u003e\u003cbr/\u003e\u003c/p\u003e\n\u003cp\u003eThe GUI looks like this:\n\u003cimg src=\"/projects/graphtheoryvisualizer/interface.gif\" alt=\"\"\u003e\u003c/p\u003e\n\u003cp\u003eand allows:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003ecreate new vertex (on-screen \u003ccode\u003evertex\u003c/code\u003e button)\u003c/li\u003e\n\u003cli\u003ecreate an arc between two vertices (on-screen \u003ccode\u003eedge\u003c/code\u003e button) by clicking first on the first vertex and then on the second\u003c/li\u003e\n\u003cli\u003eremove an arc between two vertices by clicking on it\u003c/li\u003e\n\u003cli\u003eset the graph as weighted and/or directed (switches present on the screen)\u003c/li\u003e\n\u003cli\u003esee the adjacency list as a dropdown. Notice how if the graph changes for example if you remove an arc, the list changes in real time\u003c/li\u003e\n\u003cli\u003evisualize the possible operations on a graph. It is necessary to choose the operation with the dropdown present in the navbar and then start the visualization. Note how even in this case, for example if we choose to display the Dijkstra algorithm and in the process we change the graph by moving the vertices, then the output of the algorithm also changes in real time. The output of an algorithm is displayed on the graph by highlighting vertices and arcs in blue.\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch2 id=\"examples\"\u003eexamples\u003c/h2\u003e\n\u003cp\u003edepth-first search (DFS):\n\u003cimg src=\"/projects/graphtheoryvisualizer/dfs.gif\" alt=\"\"\u003e\u003c/p\u003e\n\u003cp\u003edijkstra shortest path between 2 vertices:\n\u003cimg src=\"/projects/graphtheoryvisualizer/dijkstra.gif\" alt=\"\"\u003e\u003c/p\u003e\n\u003cp\u003ekruskal minimum spanning tree:\n\u003cimg src=\"/projects/graphtheoryvisualizer/kruskal.gif\" alt=\"\"\u003e\u003c/p\u003e\n\u003cp\u003eProject done using \u003ca href=\"https://p5js.org/\"\u003ep5js\u003c/a\u003e and \u003ca href=\"https://www.typescriptlang.org/\"\u003eTypeScript\u003c/a\u003e.\u003c/p\u003e\n","description":"","image":"/projects/graphtheoryvisualizer/graph.png","permalink":"/en/projects/graph-theory-visualizer/","title":"graph theory visualizer"}]